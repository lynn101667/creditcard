<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ¯›æ¯›ä¸»äººçš„ä¿¡ç”¨å¡ V54</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ¯›æ¯›è¨˜å¸³">
    <link rel="manifest" href='data:application/manifest+json,{"name":"æ¯›æ¯›è¨˜å¸³","short_name":"æ¯›æ¯›è¨˜å¸³","start_url":".","display":"standalone","background_color":"#f0f4f8","theme_color":"#6366F1","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/2382/2382461.png","sizes":"192x192","type":"image/png"}]}'>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { aurora: { primary: '#6366F1', accent: '#EC4899' } },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'], serif: ['"Noto Serif TC"', 'serif'] },
                    boxShadow: { 'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)' }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); background-attachment: fixed; min-height: 100vh; overscroll-behavior-y: none; padding-bottom: env(safe-area-inset-bottom); }
        h1, h2, h3, .serif-font { font-family: 'Noto Serif TC', serif; }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .custom-checkbox input:checked + div { background-color: #6366F1; border-color: #6366F1; color: white; }
        .tab-btn { color: #94A3B8; transition: all 0.3s; }
        .tab-btn.active { color: #6366F1; transform: translateY(-2px); }
        .fab { background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        .loading-overlay { background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); z-index: 100; }
        button { pointer-events: auto; }
        .tx-row { transition: background-color 0.2s; cursor: pointer; }
        .tx-row:active { background-color: #F1F5F9; transform: scale(0.98); }
        .bank-badge { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 999px; color: white; font-weight: bold; font-size: 0.7rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .input-box-fixed { background-color: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 1rem; padding: 0.75rem 1rem; display: flex; align-items: center; width: 100%; }
        select { -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394A3B8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; }
        
        .float-btn-group { position: fixed; bottom: 85px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 45; }
        .float-mini-btn { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .btn-top { background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); color: #6366F1; opacity: 0; transform: translateY(10px); pointer-events: none; border: 1px solid #EEF2FF; }
        .btn-top.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .btn-bot { background: linear-gradient(135deg, #EC4899 0%, #F43F5E 100%); box-shadow: 0 4px 12px rgba(236, 72, 153, 0.4); color: white; transform: scale(0); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .btn-bot.show { transform: scale(1); }
        .btn-bot:active { transform: scale(0.9); }

        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .toggle-switch { position: relative; width: 40px; height: 22px; background: #CBD5E0; border-radius: 20px; transition: 0.3s; }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; background: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .toggle-checked { background: #6366F1; }
        .toggle-checked::after { transform: translateX(18px); }
        
        .suggestions-box { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #E2E8F0; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 50; max-height: 250px; overflow-y: auto; margin-top: 4px; }
        .suggestion-item { padding: 0.75rem 1rem; cursor: pointer; font-size: 0.875rem; color: #475569; border-bottom: 1px solid #F1F5F9; display:flex; justify-content:space-between; align-items:center; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #F8FAFC; color: #6366F1; font-weight: bold; }
        .suggestion-match { color: #6366F1; font-weight: bold; }
        .suggestion-city { font-size: 0.7rem; color: #94A3B8; background: #F1F5F9; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body class="pb-24 text-slate-700">

    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full text-xs font-bold shadow-lg z-[80] transition-opacity duration-300 opacity-0 pointer-events-none">âœ… å·²æ›´æ–°</div>
    
    <div id="loadingOverlay" class="fixed inset-0 loading-overlay hidden flex flex-col items-center justify-center">
        <div class="relative w-16 h-16 mb-4">
            <div class="absolute inset-0 border-4 border-indigo-100 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-indigo-500 rounded-full border-t-transparent animate-spin"></div>
            <i data-lucide="cloud-upload" class="absolute inset-0 m-auto w-6 h-6 text-indigo-500 animate-pulse"></i>
        </div>
        <span class="text-sm font-bold text-indigo-600 tracking-widest animate-pulse" id="loadingText">é›²ç«¯åŒæ­¥ä¸­...</span>
    </div>

    <!-- Header -->
    <div class="sticky top-0 z-30 bg-white/80 backdrop-blur-md shadow-sm border-b border-white/50 transition-all duration-300">
        <div class="max-w-md mx-auto px-5 py-4">
            <div class="flex justify-between items-center mb-2">
                <h1 class="text-indigo-600 text-xl font-bold flex items-center gap-2 tracking-wide" onclick="window.scrollTo({top:0, behavior:'smooth'})"><i data-lucide="paw-print" class="w-5 h-5 text-pink-500"></i> æ¯›æ¯›ä¸»äººçš„ä¿¡ç”¨å¡</h1>
                <div id="totalSpendDisplay" class="text-slate-500 text-xs font-bold bg-indigo-50 px-3 py-1.5 rounded-full border border-indigo-100 hidden">æœ¬æœŸ $0</div>
            </div>
            
            <div id="headerControls" class="mt-2 space-y-3">
                <div class="relative bg-white rounded-xl shadow-sm border border-indigo-50 flex items-center">
                    <i data-lucide="search" class="absolute left-3 w-4 h-4 text-indigo-300"></i>
                    <input type="text" id="searchInput" placeholder="æœå°‹æ¬Šç›Šã€é¤å»³ã€å„ªæƒ ..." class="w-full pl-10 pr-10 py-3 rounded-xl border-none outline-none bg-transparent text-slate-700 placeholder-indigo-200 text-sm font-medium">
                    <button id="clearBtn" class="absolute right-3 hidden text-slate-400 hover:text-indigo-500 p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <div id="quickSelectContainer" class="grid grid-cols-2 gap-3 fade-in">
                    <div class="relative"><select id="bankSelect" class="w-full bg-white/60 border border-white/60 rounded-lg py-2 pl-3 pr-8 text-xs font-bold text-slate-600 outline-none focus:ring-1 focus:ring-indigo-300"><option value="">æ‰€æœ‰éŠ€è¡Œ</option></select></div>
                    <div class="relative"><select id="cardSelect" class="w-full bg-white/60 border border-white/60 rounded-lg py-2 pl-3 pr-8 text-xs font-bold text-slate-600 outline-none disabled:opacity-50 focus:ring-1 focus:ring-indigo-300" disabled><option value="">æ‰€æœ‰å¡ç‰‡</option></select></div>
                </div>
            </div>

            <div id="manageControls" class="mt-2 hidden fade-in space-y-3">
                 <div class="flex items-center justify-between gap-2">
                    <div class="flex items-center gap-2 cursor-pointer bg-indigo-50/50 p-2.5 rounded-xl border border-indigo-50 flex-1" onclick="toggleActiveOnly()">
                        <div id="toggleActiveSwitch" class="toggle-switch flex-shrink-0"></div>
                        <span class="text-xs font-bold text-slate-600">åƒ…é¡¯ç¤ºæ¶ˆè²»ä¿¡ç”¨å¡</span>
                    </div>
                    <button onclick="document.getElementById('cloudModal').classList.remove('hidden')" class="w-11 h-11 flex items-center justify-center bg-white border border-indigo-50 rounded-xl text-indigo-400 shadow-sm hover:text-indigo-600 active:scale-95 transition">
                        <i data-lucide="cloud" class="w-5 h-5"></i>
                    </button>
                 </div>

                <div class="flex gap-2">
                    <div class="relative flex-1">
                        <select id="manageCardFilter" class="w-full bg-white/90 border border-indigo-100 rounded-xl py-2.5 pl-3 pr-8 text-xs font-bold text-slate-600 outline-none shadow-sm focus:ring-2 focus:ring-indigo-200">
                            <option value="">ğŸ’³ æ‰€æœ‰ä¿¡ç”¨å¡</option>
                        </select>
                    </div>
                    <button onclick="window.openHistoryModal()" class="flex-none px-4 py-2.5 bg-indigo-500 text-white rounded-xl shadow-md text-xs font-bold flex items-center gap-1 active:scale-95 transition-transform hover:bg-indigo-600">
                        <i data-lucide="receipt" class="w-4 h-4"></i> æ­·å²å¸³æœ¬
                    </button>
                </div>
            </div>

            <div id="smallPayControls" class="hidden fade-in mt-2 space-y-3">
                 <div class="bg-white p-4 rounded-2xl border border-orange-100 shadow-sm relative">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <i data-lucide="shield-alert" class="w-5 h-5 text-orange-500"></i>
                            <h2 class="text-sm font-bold text-slate-800">å°é¡æ”¯ä»˜å¹³å°æŸ¥è©¢</h2>
                        </div>
                        <button onclick="document.getElementById('smallPayDbModal').classList.remove('hidden')" class="text-[10px] text-indigo-500 underline">æ‰‹å‹•åŒ¯å…¥</button>
                    </div>
                    
                    <div class="relative mb-3">
                        <div class="relative bg-slate-50 rounded-xl shadow-inner border border-slate-200 flex items-center">
                            <i data-lucide="search" class="absolute left-3 w-4 h-4 text-slate-400"></i>
                            <input type="text" id="smallPayInput" placeholder="è¼¸å…¥å“ç‰Œ (å¦‚: é¶´èŒ¶æ¨“)..." autocomplete="off" class="w-full pl-10 pr-10 py-3 rounded-xl border-none outline-none bg-transparent text-slate-700 placeholder-slate-400 text-sm font-bold" oninput="onSmallPayInput(this.value)">
                            <button onclick="clearSmallPaySearch()" class="absolute right-3 text-slate-300 hover:text-slate-500 p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
                        </div>
                        <div id="smallPaySuggestions" class="suggestions-box hidden"></div>
                    </div>

                    <div class="relative">
                        <select id="smallPayCitySelect" onchange="filterSmallPayByCity()" class="w-full bg-orange-50/50 border border-orange-100 rounded-xl py-2.5 pl-3 pr-8 text-xs font-bold text-slate-600 outline-none focus:ring-2 focus:ring-orange-200">
                            <option value="">ğŸ™ï¸ ä¾ç¸£å¸‚æŸ¥è©¢åº—å®¶</option>
                        </select>
                    </div>
                 </div>
                 
                 <div id="smallPayResult" class="hidden animate-in fade-in slide-in-from-top-2"></div>
                 <div class="text-[10px] text-slate-300 text-center mt-2" id="smallPayStats">è³‡æ–™è¼‰å…¥ä¸­...</div>
            </div>

        </div>
    </div>

    <!-- Floating Buttons -->
    <div class="float-btn-group">
        <button id="btnAiBot" onclick="openAiChat()" class="float-mini-btn btn-bot hidden">
            <i data-lucide="bot" class="w-6 h-6"></i>
        </button>
        <button id="btnBackToTop" onclick="window.scrollTo({top:0, behavior:'smooth'})" class="float-mini-btn btn-top">
            <i data-lucide="arrow-up" class="w-5 h-5"></i>
        </button>
    </div>

    <div id="mainContent" class="max-w-md mx-auto px-4 pt-4 space-y-5 min-h-[60vh]"></div>
    <div id="noResult" class="hidden text-center py-20 opacity-60"><div class="bg-white/50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm backdrop-blur-sm"><i data-lucide="cloud-off" class="w-10 h-10 text-indigo-200"></i></div><p class="text-indigo-400 font-bold text-sm tracking-widest">æš«ç„¡ç¬¦åˆè³‡æ–™</p></div>

    <div class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-xl border-t border-indigo-50 z-40 pb-[env(safe-area-inset-bottom)]">
        <div class="max-w-md mx-auto grid grid-cols-3 h-16 relative"> 
            <button onclick="switchTab('search')" class="tab-btn flex flex-col items-center justify-center gap-1" id="btnSearch"><i data-lucide="library" class="w-5 h-5"></i><span class="text-[10px] font-bold tracking-wide">æ¬Šç›ŠæŸ¥è©¢</span></button>
            <button onclick="switchTab('manage')" class="tab-btn active flex flex-col items-center justify-center gap-1" id="btnManage"><i data-lucide="wallet-cards" class="w-5 h-5"></i><span class="text-[10px] font-bold tracking-wide">å¸³å‹™ç®¡ç†</span></button>
            <button onclick="switchTab('smallpay')" class="tab-btn flex flex-col items-center justify-center gap-1" id="btnSmallPay"><i data-lucide="shield-alert" class="w-5 h-5"></i><span class="text-[10px] font-bold tracking-wide">å°é¡æŸ¥è©¢</span></button>
            
            <div id="fabContainer" class="absolute left-1/2 -top-6 -translate-x-1/2 hidden fade-in z-50 pointer-events-auto" style="display:block;">
                <button onclick="openTransactionModal()" class="fab text-white w-14 h-14 rounded-full flex items-center justify-center transition-transform active:scale-95 group pointer-events-auto shadow-xl">
                    <i data-lucide="plus" class="w-7 h-7"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- AI Chat Modal -->
    <div id="aiChatModal" class="fixed inset-0 bg-slate-900/60 z-[70] hidden flex flex-col justify-end sm:justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:max-w-sm sm:mx-auto sm:rounded-3xl rounded-t-3xl h-[80vh] sm:h-[600px] flex flex-col shadow-2xl animate-in slide-in-from-bottom-10">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-pink-500 to-rose-500 text-white sm:rounded-t-3xl rounded-t-3xl">
                <div class="flex items-center gap-2"><i data-lucide="bot" class="w-6 h-6"></i><h3 class="font-bold">AI æ™ºèƒ½å®¢æœ</h3></div>
                <button onclick="document.getElementById('aiChatModal').classList.add('hidden')" class="p-1 hover:bg-white/20 rounded-full transition"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex-1 p-4 overflow-y-auto space-y-4 bg-slate-50" id="aiChatContent">
                <div class="flex gap-3"><div class="w-8 h-8 rounded-full bg-gradient-to-br from-pink-400 to-rose-400 flex items-center justify-center text-white flex-shrink-0"><i data-lucide="bot" class="w-4 h-4"></i></div><div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 max-w-[80%]">ä½ å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ä¿¡ç”¨å¡å°å¹«æ‰‹ã€‚<br>å‘Šè¨´æˆ‘æ‚¨æƒ³æ¶ˆè²»çš„é …ç›®ï¼Œä¾‹å¦‚ï¼šã€Œæƒ³å–<b>50åµ</b>ã€ã€ã€Œè¦åƒ<b>è‚¯å¾·åŸº</b>ã€ã€ã€Œç¹³<b>ä¿è²»</b>ã€ï¼Œæˆ‘æœƒè‡ªå‹•å¹«æ‚¨æ‰¾é©åˆçš„å¡ç‰‡ï¼Œä¸¦å¹«æ‚¨æª¢æŸ¥æ˜¯å¦ç‚ºå°é¡æ”¯ä»˜å–”ï¼</div></div>
            </div>
            <div class="p-4 bg-white border-t border-slate-100 flex gap-2 pb-[calc(1rem+env(safe-area-inset-bottom))]">
                <input type="text" id="aiInput" class="flex-1 bg-slate-100 border-none rounded-xl px-4 py-2.5 text-sm outline-none focus:ring-2 focus:ring-pink-200" placeholder="è¼¸å…¥ï¼šæˆ‘æƒ³å–å¯ä¸å¯..." onkeypress="if(event.key==='Enter') sendAiMessage()">
                <button onclick="sendAiMessage()" class="bg-pink-500 text-white p-2.5 rounded-xl hover:bg-pink-600 transition"><i data-lucide="send" class="w-4 h-4"></i></button>
            </div>
        </div>
    </div>

    <!-- Other Modals -->
    <div id="smallPayDbModal" class="fixed inset-0 bg-slate-900/60 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl fade-in"><h3 class="font-bold text-lg mb-1 text-slate-800 serif-font">åŒ¯å…¥å°é¡æ”¯ä»˜å®Œæ•´åå–®</h3><p class="text-xs text-slate-400 mb-4">è²¼ä¸Š CSV ç¶²å€</p><input type="text" id="smallPayCsvUrl" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-xs text-slate-600 outline-none mb-2" placeholder="https://docs.google.com/..."><div class="flex gap-2"><button onclick="document.getElementById('smallPayDbModal').classList.add('hidden')" class="flex-1 py-2 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">å–æ¶ˆ</button><button onclick="saveSmallPayDb()" class="flex-1 py-2 rounded-xl bg-indigo-600 text-white font-bold shadow-md text-sm">åŒ¯å…¥</button></div></div></div>
    <div id="cloudModal" class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl fade-in"><h3 class="font-bold text-lg mb-1 text-slate-800 serif-font">é›²ç«¯è³‡æ–™åº«è¨­å®š</h3><p class="text-xs text-slate-400 mb-4">è²¼ä¸Š Apps Script ç¶²å€</p><input type="text" id="gasUrl" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-xs text-slate-600 outline-none mb-2" placeholder="https://script.google.com/..."><div class="flex gap-2"><button onclick="document.getElementById('cloudModal').classList.add('hidden')" class="flex-1 py-2 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">å–æ¶ˆ</button><button onclick="saveCloudSettings()" class="flex-1 py-2 rounded-xl bg-indigo-600 text-white font-bold shadow-md text-sm">é€£çµä¸¦åŒæ­¥</button></div></div></div>
    <div id="deleteConfirmModal" class="fixed inset-0 bg-slate-900/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl fade-in transform transition-all scale-100"><div class="flex flex-col items-center text-center mb-4"><div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-3"><i data-lucide="trash-2" class="w-6 h-6 text-red-500"></i></div><h3 class="font-bold text-lg text-slate-800">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h3><p class="text-xs text-slate-500 mt-1">åˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸã€‚</p></div><div class="flex gap-3"><button onclick="document.getElementById('deleteConfirmModal').classList.add('hidden')" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-600 font-bold text-sm">å–æ¶ˆ</button><button onclick="executeDelete()" class="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold shadow-md text-sm">ç¢ºèªåˆªé™¤</button></div></div></div>
    
    <!-- Transaction Modal -->
    <div id="transactionModal" class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full sm:max-w-sm rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-in slide-in-from-bottom-10 duration-300 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-slate-800 serif-font" id="txModalTitle">è¨˜ä¸€ç­†æ¶ˆè²»</h3><button onclick="closeTransactionModal()" class="bg-slate-100 p-2 rounded-full text-slate-500 hover:bg-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-400 mb-1.5 block">é¸æ“‡å¡ç‰‡</label><select id="txCardSelect" class="w-full bg-slate-50 border-none rounded-2xl p-3.5 text-slate-700 outline-none font-bold text-sm focus:ring-2 focus:ring-indigo-200"></select></div>
                <div class="flex gap-3"><div class="flex-1"><label class="text-xs font-bold text-slate-400 mb-1.5 block">é‡‘é¡</label><input type="number" id="txAmount" class="w-full bg-slate-50 border-none rounded-2xl p-3.5 text-xl font-bold text-slate-800 outline-none focus:ring-2 focus:ring-indigo-200" placeholder="$0"></div><div class="w-1/3"><label class="text-xs font-bold text-slate-400 mb-1.5 block">æ—¥æœŸ</label><input type="date" id="txDate" class="w-full bg-slate-50 border-none rounded-2xl p-3.5 text-xs font-bold text-slate-600 outline-none focus:ring-2 focus:ring-indigo-200"></div></div>
                <div><label class="text-xs font-bold text-slate-400 mb-1.5 block">æ¶ˆè²»é¡åˆ¥ <span class="text-red-400">*</span></label><div class="relative"><select id="txCategory" class="w-full bg-slate-50 border-none rounded-2xl p-3.5 text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-200"></select></div></div>
                <div><label class="text-xs font-bold text-slate-400 mb-1.5 block">æ¶ˆè²»ç´°é … <span class="text-indigo-400 text-[10px]">(é¸å¡«)</span></label><input type="text" id="txItem" class="w-full bg-slate-50 border-none rounded-2xl p-3.5 text-sm text-slate-700 outline-none focus:ring-2 focus:ring-indigo-200" placeholder="ä¾‹å¦‚ï¼šéº¥ç•¶å‹ã€å…¨è¯..."></div>
                <div><label class="text-xs font-bold text-slate-400 mb-1.5 block">æ¶ˆè²»é¡å‹</label><div class="flex gap-3"><label class="flex-1 cursor-pointer custom-checkbox"><input type="checkbox" id="checkReward" value="reward" class="hidden" checked><div class="border border-slate-200 rounded-xl py-3 text-center text-xs font-bold text-slate-500 transition-colors select-none">æŒ‡å®šå›é¥‹</div></label><label class="flex-1 cursor-pointer custom-checkbox"><input type="checkbox" id="checkGeneral" value="general" class="hidden"><div class="border border-slate-200 rounded-xl py-3 text-center text-xs font-bold text-slate-500 transition-colors select-none">ä¸€èˆ¬/ä½æ¶ˆ</div></label></div></div>
                <div><input type="text" id="txNote" class="w-full bg-transparent border-b border-slate-200 p-2 text-sm text-slate-600 outline-none placeholder-slate-300" placeholder="å‚™è¨» (é¸å¡«)..."></div>
                <div class="flex gap-3 mt-4 pt-2"><button id="btnDeleteTx" class="hidden flex-1 py-3.5 rounded-2xl border border-red-200 text-red-500 font-bold bg-red-50 hover:bg-red-100 transition-colors">åˆªé™¤</button><button onclick="saveTransaction()" class="flex-[2] bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-bold py-3.5 rounded-2xl shadow-lg hover:shadow-indigo-200/50 transition-all active:scale-[0.98]">å„²å­˜</button></div>
            </div>
        </div>
    </div>

    <!-- History & Settings Modals -->
    <div id="historyModal" class="fixed inset-0 bg-slate-50 z-50 hidden flex flex-col"><div class="bg-white border-b border-slate-100 p-4 pt-safe-top flex justify-between items-center shadow-sm z-10 sticky top-0"><div class="flex items-center gap-2"><button onclick="closeHistoryModal()" class="p-2 -ml-2 text-slate-400 hover:text-indigo-600"><i data-lucide="arrow-left" class="w-6 h-6"></i></button><h2 class="text-lg font-bold text-slate-800 serif-font">æ­·å²å¸³æœ¬</h2></div><div class="text-sm font-bold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full" id="historyTotalDisplay">$0</div></div><div class="flex-1 overflow-y-auto p-4 space-y-3" id="historyListContainer"></div></div>
    <div id="settingsModal" class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl fade-in"><h3 class="font-bold text-lg mb-1 text-slate-800 serif-font">å¡ç‰‡è¨­å®š</h3><div class="space-y-4 mt-4"><div><label class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-1.5 block">æœ€ä½³å›é¥‹ä¸Šé™</label><div class="input-box-fixed"><span class="text-indigo-400 font-bold mr-2">$</span><input type="number" id="settingCap" class="flex-1 bg-transparent outline-none text-slate-700 font-bold text-lg h-6" placeholder="ç„¡ä¸Šé™"></div></div><div><label class="text-[10px] font-bold text-orange-400 uppercase tracking-widest mb-1.5 block">ä½æ¶ˆé–€æª»</label><div class="input-box-fixed"><span class="text-orange-400 font-bold mr-2">$</span><input type="number" id="settingMin" class="flex-1 bg-transparent outline-none text-slate-700 font-bold text-lg h-6" placeholder="0"></div></div><div class="bg-slate-50 p-4 rounded-2xl border border-slate-100"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 block">è¨ˆç®—é€±æœŸ</label><div class="flex gap-2 mb-3"><button type="button" onclick="setCycleMode('month')" id="btnCycleMonth" class="flex-1 py-2 text-xs font-bold rounded-lg border">æ—¥æ›†æœˆ</button><button type="button" onclick="setCycleMode('bill')" id="btnCycleBill" class="flex-1 py-2 text-xs font-bold rounded-lg border">çµå¸³æ—¥</button></div><div id="billDateInputGroup" class="hidden flex items-center gap-2 justify-center"><span class="text-xs text-slate-500 font-bold">æ¯æœˆ</span><input type="number" id="settingBillDay" min="1" max="31" class="w-14 text-center bg-white rounded-lg border border-slate-200 outline-none text-sm font-bold text-indigo-600 py-1.5" value="1"><span class="text-xs text-slate-500 font-bold">æ—¥ çµå¸³</span></div></div></div><div class="flex gap-3 mt-6"><button onclick="closeSettingsModal()" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">å–æ¶ˆ</button><button onclick="saveCardSettings()" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold shadow-md text-sm">ç¢ºèª</button></div></div></div>

    <script>
        const DEFAULT_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhVkQJhNqPQAxXv-q0ethYeViFm69TyPnqRTmejQdwqgKtOvOLRbZ7toKBBTq7rWiqkQFMtGxvvWpC/pub?output=csv";
        const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbx4fis6JsM0YYp1KUzRb0xAPnhJPqIgR-MVtc8AGWjLjbFCXHWT5xW2JqAsGiw_B0d1IQ/exec";
        const DEFAULT_SMALL_PAY_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSP7uOSfbfEnZx_TsDltCox5ubDR3f5ofOK7g-WEAp-y38coNSnY_VHfY1WuI8tqA/pub?output=csv";

        const TX_CATEGORIES = ["ğŸ½ï¸ é¤é£²", "ğŸ¥¦ é£Ÿæ", "ğŸ›ï¸ è³¼ç‰©", "ğŸ¬ å¨›æ¨‚", "ğŸ’Š é†«ç™‚", "ğŸšŒ äº¤é€š", "â›½ åŠ æ²¹", "ğŸ¾ å¯µç‰©", "âœˆï¸ æ—…éŠ", "ğŸ›¡ï¸ ä¿éšª", "ğŸ“š èª²ç¨‹", "ğŸ’° ç¹³è²»", "ğŸ“¦ å…¶ä»–"];
        const TAIWAN_CITIES = ["å°åŒ—å¸‚", "æ–°åŒ—å¸‚", "åŸºéš†å¸‚", "æ¡ƒåœ’å¸‚", "æ–°ç«¹å¸‚", "æ–°ç«¹ç¸£", "è‹—æ —ç¸£", "å°ä¸­å¸‚", "å½°åŒ–ç¸£", "å—æŠ•ç¸£", "é›²æ—ç¸£", "å˜‰ç¾©å¸‚", "å˜‰ç¾©ç¸£", "å°å—å¸‚", "é«˜é›„å¸‚", "å±æ±ç¸£", "å®œè˜­ç¸£", "èŠ±è“®ç¸£", "å°æ±ç¸£"];
        
        let SMALL_PAYMENT_CHAINS = [
            "éº¥ç•¶å‹", "è‚¯å¾·åŸº", "æ¼¢å ¡ç‹", "æ‘©æ–¯", "å¿…å‹å®¢", "é”ç¾æ¨‚", "æ‹¿å¡é‡Œ",
            "7-11", "å…¨å®¶", "èŠçˆ¾å¯Œ", "OK", "çµ±ä¸€è¶…å•†", 
            "äº”ååµ", "50åµ", "æ¸…å¿ƒ", "æ¸…å¿ƒç¦å…¨", "CoCo", "éƒ½å¯", "èŒ¶æ¹¯æœƒ", 
            "è¿·å®¢å¤", "é¶´èŒ¶æ¨“", "%Arabica", "å¯ä¸å¯", "éº»å¤", "å¤§è‹‘å­",
            "å…¨è¯", "ç¾å»‰ç¤¾", "å®¶æ¨‚ç¦è¶…å¸‚",
            "å…«æ–¹é›²é›†", "ä¸‰å•†å·§ç¦", "é¬é¬šå¼µ", "çˆ­é®®", "æ¢ç¤¾æ¼¢",
            "é›»è©±äº­KTV", "åœè»Šå ´"
        ];

        let SMALL_PAYMENT_STORES_DB = [];

        let allCardsData = [], uniqueBanks = [];
        let transactions = JSON.parse(localStorage.getItem('cc_transactions_v2') || '[]');
        let cardSettings = JSON.parse(localStorage.getItem('cc_card_settings') || '{}');
        let currentView = 'manage'; 
        let showActiveOnly = false;
        let editingTransactionId = null;
        let currentBankFilter = '';
        let currentCardFilter = '';
        let manageCardFilter = '';
        let API_URL = localStorage.getItem('gas_api_url') || DEFAULT_API_URL;
        const preloadedData = [{ bank: "ç‰å±±éŠ€è¡Œ", name: "Unicard", category: "ç™¾å¤§ç‰¹åº—", rate: 3.5, cap: "500é»", desc: "ç°¡å–®é¸...", tags: ["æ–°å…‰ä¸‰è¶Š"], baseRate: "1%" }];

        function init() {
            if(!localStorage.getItem('gas_api_url')) { localStorage.setItem('gas_api_url', DEFAULT_API_URL); API_URL = DEFAULT_API_URL; }
            const url = localStorage.getItem('my_csv_url') || DEFAULT_CSV_URL;
            Papa.parse(url, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => { if (results.data?.length > 0) { allCardsData = processRawData(results.data); initDropdowns(); renderView(); if(API_URL) syncWithCloud(); } else fallbackToDefault(); },
                error: () => fallbackToDefault()
            });
            document.getElementById('txDate').valueAsDate = new Date();
            document.getElementById('gasUrl').value = API_URL;
            initCategoryDropdown();
            initCityDropdown();
            
            const smallPayUrl = localStorage.getItem('small_pay_csv_url') || DEFAULT_SMALL_PAY_CSV_URL;
            loadSmallPayCsv(smallPayUrl);
            
            switchTab('manage');
        }

        // --- GLOBAL FUNCTIONS FOR UI ---
        window.initCategoryDropdown = function() { const s = document.getElementById('txCategory'); s.innerHTML=''; TX_CATEGORIES.forEach(c => { const o = document.createElement('option'); o.value=c; o.text=c; s.appendChild(o); }); }
        window.initCityDropdown = function() { const s = document.getElementById('smallPayCitySelect'); s.innerHTML='<option value="">ğŸ™ï¸ ä¾ç¸£å¸‚æŸ¥è©¢åº—å®¶</option>'; TAIWAN_CITIES.forEach(c => { const o = document.createElement('option'); o.value=c; o.text=c; s.appendChild(o); }); }
        window.fallbackToDefault = function() { allCardsData = processRawData(preloadedData); initDropdowns(); renderView(); }
        window.processRawData = function(data) { 
            const map = new Map(); uniqueBanks = []; 
            data.forEach(row => { 
                const get = (k) => { const f = Object.keys(row).find(x => k.some(y => y.toLowerCase() === x.trim().toLowerCase())); return f ? row[f] : ""; };
                const bank = get(['éŠ€è¡Œ','bank']); const name = get(['å¡å','name']); 
                if(!bank || !name) return;
                const id = `${bank}-${name}`;
                if(!uniqueBanks.includes(bank)) uniqueBanks.push(bank);
                if(!map.has(id)) map.set(id, { id, bank, name, color: getBankColor(bank), offers: [], defaultMin: 0 });
                const obj = map.get(id);
                const min = get(['ä½æ¶ˆ', 'é–€æª»', 'min', 'low']);
                if(min) { const n = parseFloat(String(min).replace(/[^\d.]/g, '')); if(!isNaN(n) && n > 0) obj.defaultMin = n; }
                const cat = get(['é¡åˆ¥', 'category']);
                if(cat) obj.offers.push({ category: cat, rate: parseFloat(String(get(['å›é¥‹', 'rate'])).replace('%',''))||0, desc: get(['èªªæ˜', 'desc']), tags: String(get(['é—œéµå­—', 'tags'])).split(/[,ï¼Œã€]/).filter(Boolean), baseRate: get(['åŸºç¤', 'baseRate']), cap: get(['ä¸Šé™', 'cap']) });
            });
            return Array.from(map.values());
        }
        window.getBankColor = function(b) { if(b.includes("å°æ–°")) return "bg-gradient-to-r from-red-400 to-red-500"; if(b.includes("ç‰å±±")) return "bg-gradient-to-r from-emerald-400 to-emerald-500"; if(b.includes("å¯Œé‚¦")) return "bg-gradient-to-r from-cyan-500 to-blue-500"; if(b.includes("åœ‹æ³°") || b.includes("CUBE")) return "bg-gradient-to-r from-lime-500 to-green-500"; return "bg-gradient-to-r from-gray-400 to-gray-500"; }
        window.initDropdowns = function() { 
            const b = document.getElementById('bankSelect'); b.innerHTML='<option value="">æ‰€æœ‰éŠ€è¡Œ</option>'; uniqueBanks.forEach(x => { const o = document.createElement('option'); o.value=x; o.text=x; b.appendChild(o); });
            const m = document.getElementById('manageCardFilter'); m.innerHTML='<option value="">ğŸ’³ æ‰€æœ‰ä¿¡ç”¨å¡</option>'; allCardsData.forEach(c => { const o = document.createElement('option'); o.value=c.id; o.text=c.name; m.appendChild(o); });
        }
        window.getCardDefaultCap = function(id) { const c = allCardsData.find(x => x.id === id); if(c && c.offers.length > 0) for(let o of c.offers) { if(o.cap && !o.cap.includes("ç„¡")) { const n = parseFloat(o.cap.replace(/[^\d.]/g, '')); if(!isNaN(n) && n > 0) return n; } } return 0; }
        
        window.saveCloudSettings = async function() { const u = document.getElementById('gasUrl').value.trim(); if(u) { localStorage.setItem('gas_api_url', u); API_URL = u; document.getElementById('cloudModal').classList.add('hidden'); await syncWithCloud(); } }
        window.syncWithCloud = async function() { if(!API_URL) return; showLoading(true, "é›²ç«¯åŒæ­¥ä¸­..."); try { const r = await fetch(API_URL + '?action=read'); const j = await r.json(); if(j.status === 'success' && j.data) { transactions = j.data; localStorage.setItem('cc_transactions_v2', JSON.stringify(transactions)); renderView(); showToast('åŒæ­¥å®Œæˆ'); } } catch(e) {} finally { showLoading(false); } }
        window.postToCloud = async function(tx, action='save') { if(!API_URL) return; try { await fetch(API_URL + `?action=${action}${action==='delete'?'&id='+tx.id:''}`, { method: 'POST', body: JSON.stringify(tx) }); } catch(e) {} }
        
        window.showLoading = function(show, text = "é›²ç«¯åŒæ­¥ä¸­...") { 
            const overlay = document.getElementById('loadingOverlay');
            document.getElementById('loadingText').innerText = text;
            overlay.classList.toggle('hidden', !show); 
        }
        window.showToast = function(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.remove('opacity-0', 'pointer-events-none'); setTimeout(() => t.classList.add('opacity-0', 'pointer-events-none'), 2000); }

        window.switchTab = function(view) {
            currentView = view;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            const ids = ['headerControls', 'manageControls', 'smallPayControls', 'totalSpendDisplay', 'fabContainer'];
            ids.forEach(id => document.getElementById(id).classList.add('hidden'));
            
            const aiBot = document.getElementById('btnAiBot');
            const fabContainer = document.getElementById('fabContainer');

            if(view === 'search') { 
                document.getElementById('btnSearch').classList.add('active'); 
                document.getElementById('headerControls').classList.remove('hidden');
                aiBot.classList.remove('hidden'); setTimeout(()=> aiBot.classList.add('show'), 50);
            } else {
                aiBot.classList.remove('show'); setTimeout(()=> aiBot.classList.add('hidden'), 300);
            }

            if (view === 'manage') { 
                document.getElementById('btnManage').classList.add('active');
                document.getElementById('manageControls').classList.remove('hidden');
                document.getElementById('totalSpendDisplay').classList.remove('hidden');
                fabContainer.classList.remove('hidden'); fabContainer.style.display='block';
            } else if (view === 'smallpay') {
                document.getElementById('btnSmallPay').classList.add('active');
                document.getElementById('smallPayControls').classList.remove('hidden');
                fabContainer.classList.add('hidden'); fabContainer.style.display='none';
            }
            renderView();
        }

        window.renderView = function() {
            const container = document.getElementById('mainContent');
            container.innerHTML = "";
            if (currentView === 'search') renderSearchView(container);
            else if (currentView === 'manage') renderManageView(container);
            lucide.createIcons();
            checkScroll();
        }

        window.renderSearchView = function(container) {
            const searchText = document.getElementById('searchInput').value.toLowerCase().trim();
            const filtered = allCardsData.filter(c => (!currentBankFilter || c.bank === currentBankFilter) && (!currentCardFilter || c.name === currentCardFilter)).map(card => {
                const matches = card.offers.filter(offer => {
                    if (!searchText) return true;
                    return offer.desc.toLowerCase().includes(searchText) || offer.category.toLowerCase().includes(searchText) || card.name.toLowerCase().includes(searchText) || offer.tags.some(t => t.toLowerCase().includes(searchText));
                });
                const maxRate = matches.length > 0 ? Math.max(...matches.map(o => o.rate)) : 0;
                return { ...card, matches, maxRate, hasMatch: matches.length > 0 };
            }).filter(c => c.hasMatch).sort((a,b) => b.maxRate - a.maxRate);

            if(filtered.length === 0) { document.getElementById('noResult').classList.remove('hidden'); return; }
            else document.getElementById('noResult').classList.add('hidden');

            filtered.forEach(card => {
                const el = document.createElement('div');
                el.className = "glass-card rounded-3xl p-5 mb-4 fade-in relative";
                el.innerHTML = `<div class="flex gap-3 items-center mb-4 pb-2 border-b border-gray-100/50"><span class="bank-badge ${card.color}">${card.bank}</span><h3 class="font-bold text-slate-700 serif-font text-lg">${card.name}</h3></div>`;
                card.matches.forEach(offer => {
                    let displayTags = offer.tags;
                    if (searchText) { const matchingTags = offer.tags.filter(t => t.toLowerCase().includes(searchText)); if (matchingTags.length > 0) displayTags = matchingTags; }
                    
                    const TAG_LIMIT = 5;
                    const hasMore = displayTags.length > TAG_LIMIT;
                    const shownTags = displayTags.slice(0, TAG_LIMIT);
                    const hiddenTags = displayTags.slice(TAG_LIMIT);
                    
                    let tagsHtml = shownTags.map(tag => {
                        const isHit = searchText && tag.toLowerCase().includes(searchText);
                        const style = isHit ? 'bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-md' : 'bg-slate-200/70 text-slate-700';
                        return `<span class="text-[10px] px-2.5 py-1 rounded-full font-medium ${style} transition-colors">${tag}</span>`;
                    }).join('');

                    if(hasMore) {
                        const hiddenHtml = hiddenTags.map(tag => `<span class="text-[10px] px-2.5 py-1 rounded-full font-medium bg-slate-200/70 text-slate-700 hidden extra-tag-${card.id}-${offer.category.replace(/\s/g,'')}">${tag}</span>`).join('');
                        tagsHtml += hiddenHtml;
                        tagsHtml += `<button onclick="this.classList.add('hidden'); document.querySelectorAll('.extra-tag-${card.id}-${offer.category.replace(/\s/g,'')}').forEach(el=>el.classList.remove('hidden'))" class="text-[10px] px-2.5 py-1 rounded-full font-bold bg-indigo-100 text-indigo-500 hover:bg-indigo-200 transition-colors">+${hiddenTags.length}</button>`;
                    }

                    const capD = offer.cap ? `ä¸Šé™ ${offer.cap}` : 'ä¸Šé™ ?';
                    const baseD = offer.baseRate ? `åŸºç¤ ${offer.baseRate}` : 'åŸºç¤ ?';
                    el.innerHTML += `<div class="mb-4 last:mb-0"><div class="flex justify-between items-center mb-1"><h4 class="font-bold text-slate-600 text-sm flex items-center gap-1.5">â˜… ${offer.category}</h4><span class="text-xl font-bold text-indigo-500 serif-font">${offer.rate}%</span></div><div class="flex flex-wrap gap-2 mb-2 mt-1 opacity-80"><span class="text-[10px] text-slate-500 font-bold">${baseD}</span><span class="text-[10px] text-slate-500 font-bold">${capD}</span></div><p class="text-xs text-slate-500 mb-2 leading-relaxed">${offer.desc}</p><div class="flex flex-wrap gap-1.5">${tagsHtml}</div></div>`;
                });
                container.appendChild(el);
            });
        }

        window.renderManageView = function(container) {
            const today = new Date();
            let totalMonthlySpend = 0;
            let cardsToRender = allCardsData;
            if (manageCardFilter) cardsToRender = allCardsData.filter(c => c.id === manageCardFilter);

            let cardsWithStats = cardsToRender.map(card => {
                const settings = cardSettings[card.id] || { cycleType: 'month', billDay: 1, customCap: 0, customMin: 0 };
                if(!settings.customCap) { const def = getCardDefaultCap(card.id); if(def > 0) settings.customCap = def; }
                const cycle = getCycleRange(settings, today);
                const cycleTxs = transactions.filter(t => t.cardId === card.id && t.date >= cycle.start && t.date <= cycle.end);
                const rewardSpent = cycleTxs.filter(t => t.types.includes('reward')).reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const generalSpent = cycleTxs.filter(t => t.types.includes('general')).reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const distinctTotal = cycleTxs.reduce((sum, t) => sum + parseFloat(t.amount), 0);
                totalMonthlySpend += distinctTotal;
                return { ...card, rewardSpent, generalSpent, distinctTotal, settings, cycleTxs };
            });

            if (showActiveOnly) cardsWithStats = cardsWithStats.filter(c => c.distinctTotal > 0);
            document.getElementById('totalSpendDisplay').innerText = `æœ¬æœŸ $${totalMonthlySpend.toLocaleString()}`;
            
            cardsWithStats.sort((a, b) => {
                const aActive = a.distinctTotal > 0 ? 1 : 0;
                const bActive = b.distinctTotal > 0 ? 1 : 0;
                if (aActive !== bActive) return bActive - aActive; 
                return b.distinctTotal - a.distinctTotal || a.name.localeCompare(b.name);
            });

            if(cardsWithStats.length === 0) document.getElementById('noResult').classList.remove('hidden');
            else document.getElementById('noResult').classList.add('hidden');

            cardsWithStats.forEach(card => {
                const cap = parseFloat(card.settings.customCap) || 0;
                const min = parseFloat(card.settings.customMin) || card.defaultMin || 0;
                const capPercent = cap > 0 ? Math.min((card.rewardSpent / cap) * 100, 100) : 0;
                const remaining = cap > 0 ? (cap - card.rewardSpent) : null;
                const minPercent = min > 0 ? Math.min((card.generalSpent / min) * 100, 100) : 0;
                const minRemaining = min > 0 ? (min - card.generalSpent) : null;
                let barColor = capPercent > 90 ? 'bg-red-400' : 'bg-indigo-500';

                const el = document.createElement('div');
                el.className = "glass-card rounded-3xl p-5 mb-5 fade-in relative";
                
                let txListHtml = '';
                if(card.cycleTxs.length > 0) {
                    txListHtml = `<div class="mt-3 pt-2 border-t border-slate-100 space-y-2">`;
                    card.cycleTxs.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(tx => {
                        let badges = tx.types.includes('general') ? '<span class="w-1.5 h-1.5 rounded-full bg-orange-400"></span>' : '<span class="w-1.5 h-1.5 rounded-full bg-indigo-400"></span>';
                        const displayTitle = (tx.category ? tx.category.split(' ')[1] : '') + ' ' + (tx.item || tx.note || 'æ¶ˆè²»');
                        txListHtml += `
                            <div class="flex justify-between items-center text-xs tx-row p-2 rounded-lg hover:bg-slate-50 transition-colors" onclick="window.openTransactionModal('${tx.id}')">
                                <div class="flex items-center gap-2 text-slate-500">
                                    ${badges}
                                    <span class="font-mono text-slate-400">${tx.date.slice(5)}</span>
                                    <span class="font-medium text-slate-700 truncate max-w-[120px]">${displayTitle}</span>
                                </div>
                                <span class="font-bold text-slate-700">$${parseFloat(tx.amount).toLocaleString()}</span>
                            </div>`;
                    });
                    txListHtml += `</div>`;
                }

                const setBtn = `<button onclick="window.openSettingsModal('${card.id}', '${card.name}')" class="absolute top-4 right-4 text-slate-300 hover:text-indigo-500 p-2"><i data-lucide="settings-2" class="w-4 h-4"></i></button>`;
                let lowSpendHtml = '';
                if(min > 0) lowSpendHtml = `<div class="mt-4 pt-3 border-t border-indigo-50/50"><div class="flex justify-between items-end mb-1"><div class="text-[10px] text-orange-400 font-bold uppercase tracking-wider">ä½æ¶ˆé–€æª»</div><div class="text-[10px] text-slate-400 font-medium">ç›®æ¨™ $${min.toLocaleString()}</div></div><div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden mb-1 shadow-inner"><div class="h-full bg-orange-400 progress-bar" style="width: ${minPercent}%"></div></div><div class="text-right text-[10px] font-bold ${minRemaining > 0 ? 'text-slate-400' : 'text-emerald-500'}">${minRemaining > 0 ? 'å°šéœ€ $'+minRemaining.toLocaleString() : 'ğŸ‰ å·²é”æ¨™'}</div></div>`;

                el.innerHTML = `${setBtn}<div class="flex items-center gap-2 mb-1"><span class="bank-badge ${card.color}">${card.bank}</span><span class="text-[10px] text-slate-400 bg-white/50 px-2 py-0.5 rounded backdrop-blur-sm font-medium">${card.settings.cycleType === 'month' ? 'æ—¥æ›†æœˆ' : `æ¯æœˆ${card.settings.billDay}æ—¥çµ`}</span></div><h3 class="font-bold text-slate-700 text-lg mb-4 serif-font tracking-wide">${card.name}</h3><div class="flex justify-between items-end mb-2"><div><div class="text-[10px] text-indigo-400 font-bold mb-0.5 uppercase tracking-wider">æœ¬æœŸå›é¥‹æ¶ˆè²»</div><div class="font-bold text-slate-700 text-xl tracking-tight serif-font">$${card.rewardSpent.toLocaleString()}</div></div><div class="text-right"><div class="text-[10px] text-slate-400 font-bold mb-0.5">é¡åº¦ ${cap > 0 ? '$'+cap.toLocaleString() : '-'}</div><div class="font-bold ${remaining !== null && remaining < 0 ? 'text-red-400' : 'text-emerald-500'} text-sm">${remaining !== null ? (remaining >= 0 ? 'å‰© $'+remaining.toLocaleString() : 'è¶…é¡ $'+Math.abs(remaining).toLocaleString()) : 'âˆ'}</div></div></div><div class="h-2.5 w-full bg-slate-100 rounded-full overflow-hidden shadow-inner"><div class="h-full ${barColor} progress-bar" style="width: ${capPercent}%"></div></div>${lowSpendHtml}${txListHtml}`;
                container.appendChild(el);
            });
            const pad = document.createElement('div'); pad.className = "h-12"; container.appendChild(pad);
        }

        window.loadSmallPayCsv = function(url) {
            document.getElementById('smallPayStats').innerText = "æ­£åœ¨æ›´æ–°å°é¡æ”¯ä»˜è³‡æ–™åº«...";
            Papa.parse(url, {
                download: true, header: false, skipEmptyLines: true,
                complete: (results) => {
                    if (results.data && results.data.length > 0) {
                        const newStores = results.data.map(row => ({ name: row[0] || '', city: row[1] || 'å…¨å°', address: row[2] || '' })).filter(s => s.name && s.name !== "ç‰¹ç´„å•†åº—åç¨±");
                        // Add generics
                        SMALL_PAYMENT_CHAINS.forEach(c => newStores.push({ name: c, city: "å…¨å°", address: "å„åˆ†åº—" }));
                        // De-dup
                        const uniqueMap = new Map();
                        newStores.forEach(item => {
                            const key = item.name + (item.address || '');
                            if (!uniqueMap.has(key)) uniqueMap.set(key, item);
                        });
                        SMALL_PAYMENT_STORES_DB = Array.from(uniqueMap.values());
                        document.getElementById('smallPayStats').innerText = `è³‡æ–™åº«ï¼š${SMALL_PAYMENT_STORES_DB.length} ç­†åº—å®¶`;
                    }
                }
            });
        }

        window.openAiChat = function() { document.getElementById('aiChatModal').classList.remove('hidden'); }
        
        window.sendAiMessage = function() {
            const input = document.getElementById('aiInput');
            const msg = input.value.trim().toLowerCase();
            if(!msg) return;

            const chatBox = document.getElementById('aiChatContent');
            chatBox.innerHTML += `<div class="flex gap-3 justify-end mb-4"><div class="bg-pink-500 text-white p-3 rounded-2xl rounded-tr-none shadow-sm text-sm max-w-[80%]">${input.value}</div></div>`;
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            const greetings = ['hi', 'hello', 'ä½ å¥½', 'æ—©å®‰', 'åˆå®‰', 'æ™šå®‰', 'å“ˆå›‰', 'è¬è¬', 'æ„Ÿæ©', 'æ²’äº†', 'æ°æ°'];
            if(greetings.some(g => msg.includes(g))) {
                setTimeout(() => {
                    chatBox.innerHTML += `<div class="flex gap-3 mb-4"><div class="w-8 h-8 rounded-full bg-gradient-to-br from-pink-400 to-rose-400 flex items-center justify-center text-white flex-shrink-0"><i data-lucide="bot" class="w-4 h-4"></i></div><div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 max-w-[80%]">ä½ å¥½å‘€ï¼ä»Šå¤©æƒ³åˆ·å“ªå¼µå¡å‘¢ï¼Ÿæˆ‘å¯ä»¥å¹«æ‚¨æ‰¾å„ªæƒ å–”ï¼ğŸ˜Š</div></div>`;
                    chatBox.scrollTop = chatBox.scrollHeight;
                    lucide.createIcons();
                }, 600);
                return;
            }

            // 1. Detect Intent
            const smartMapping = {
                "é¤é£²": ["åƒ", "é¤“", "éº¥ç•¶å‹", "è‚¯å¾·åŸº", "æ¼¢å ¡ç‹", "æ‘©æ–¯", "æ˜Ÿå·´å…‹", "è·¯æ˜“è", "ç‹å“", "ç“¦åŸ", "è—å£½å¸", "å£½å¸éƒ", "ç«é‹", "ç‡’è‚‰", "ç‰›æ’", "èšé¤", "foodpanda", "ubereats", "é¥—é£Ÿå¤©å ‚", "æ¬£è‘‰", "50åµ", "äº”ååµ", "è¿·å®¢å¤", "å¯ä¸å¯", "æ¸…å¿ƒ", "coco", "èŒ¶æ¹¯æœƒ", "é¶´èŒ¶æ¨“", "éº»å¤", "å¤§è‹‘å­", "é£²æ–™", "å¥½å–", "å¥½æƒ³åƒ"],
                "äº¤é€š": ["é«˜éµ", "å°éµ", "æ·é‹", "å…¬è»Š", "å®¢é‹", "åŠ æ²¹", "ä¸­æ²¹", "å°äº", "å…¨åœ‹", "åœè»Š", "uber", "è¨ˆç¨‹è»Š", "yoxi", "55688", "line taxi", "é€šå‹¤"],
                "æ—…éŠ": ["æ©Ÿç¥¨", "é£¯åº—", "ä½å®¿", "è¨‚æˆ¿", "agoda", "booking", "hotels", "airbnb", "å‡ºåœ‹", "æ—¥æœ¬", "éŸ“åœ‹", "æ³°åœ‹", "æ­æ´²", "æ©Ÿå ´", "å…ç¨…", "æ—…è¡Œ"],
                "ç¶²è³¼": ["è¦çš®", "momo", "pchome", "æ·˜å¯¶", "amazon", "é…·æ¾", "coupang", "yahoo", "éœ²å¤©", "åšå®¢ä¾†", "è²·æ±è¥¿", "ä¸‹å–®"],
                "é›»å½±": ["å¨ç§€", "åœ‹è³“", "ç§€æ³°", "æ–°å…‰", "å–œæ¨‚æ™‚ä»£", "çœ‹æˆ²", "èœ˜è››äºº", "marvel", "é˜¿å‡¡é”", "é›»å½±"],
                "æ”¯ä»˜": ["line pay", "è¡—å£", "apple pay", "google pay", "å°ç£pay", "æ‚ éŠä»˜", "å…¨ç›ˆ", "icash", "è¡Œå‹•æ”¯ä»˜"],
                "è¶…å•†": ["7-11", "å…¨å®¶", "èŠçˆ¾å¯Œ", "ok", "ä¾¿åˆ©å•†åº—"]
            };

            let expandedKeywords = [msg];
            let detectedIntent = "";

            for (const [category, keywords] of Object.entries(smartMapping)) {
                if (keywords.some(k => msg.includes(k))) {
                    expandedKeywords.push(category); 
                    if(category === "é¤é£²") expandedKeywords.push("é¤å»³");
                    if(category === "ç¶²è³¼") expandedKeywords.push("è³¼ç‰©");
                    detectedIntent = category;
                    break; 
                }
            }

            // 2. Check Small Payment
            let smallPayWarning = "";
            const isSmallPay = SMALL_PAYMENT_CHAINS.some(c => msg.includes(c.toLowerCase()));
            const dbMatch = SMALL_PAYMENT_STORES_DB.find(s => msg.includes(s.name.toLowerCase()));
            
            if (isSmallPay || dbMatch) {
                smallPayWarning = `
                <div class="bg-red-50 border border-red-100 p-2.5 rounded-xl mb-3 flex gap-2 items-start">
                    <i data-lucide="alert-triangle" class="w-4 h-4 text-red-500 mt-0.5 flex-shrink-0"></i>
                    <div class="text-xs text-red-600">
                        <b>æ³¨æ„ï¼š</b>ã€Œ${msg}ã€å±¬æ–¼å°é¡æ”¯ä»˜å¹³å°åå–®ï¼<br>
                        ç›´æ¥åˆ·å¡å¯èƒ½<b>æ²’æœ‰å›é¥‹</b>ã€‚<br>
                        å»ºè­°ä½¿ç”¨ï¼šè¡—å£ / LinePay / å…¨æ”¯ä»˜ã€‚
                    </div>
                </div>`;
            }

            // 3. Search Cards (Enhanced Keyword Search from CSV)
            let results = [];
            if(allCardsData && allCardsData.length > 0) {
                allCardsData.forEach(card => {
                    card.offers.forEach(offer => {
                        let score = 0;
                        let matchedReason = "";

                        // Check raw input first
                        if (offer.tags.some(t => t.toLowerCase().includes(msg))) { score += 5; matchedReason = msg; }
                        else if (offer.desc.toLowerCase().includes(msg)) { score += 3; matchedReason = msg; }
                        
                        // Then check expanded keywords
                        if(score === 0) {
                            expandedKeywords.forEach(k => {
                                if (offer.tags.some(t => t.toLowerCase().includes(k))) { score += 4; matchedReason = k; }
                                else if (offer.desc.toLowerCase().includes(k)) { score += 2; matchedReason = k; }
                                else if (offer.category.toLowerCase().includes(k)) { score += 3; matchedReason = k; }
                            });
                        }

                        if (score > 0) {
                            const existing = results.find(r => r.cardName === card.name && r.category === offer.category);
                            if(!existing) results.push({ 
                                cardName: card.name, 
                                bank: card.bank, 
                                rate: offer.rate, 
                                desc: offer.desc, 
                                category: offer.category, 
                                score: score,
                                reason: matchedReason
                            });
                        }
                    });
                });
            }

            setTimeout(() => {
                let replyHtml = smallPayWarning;
                if(results.length > 0) {
                    results.sort((a, b) => b.rate - a.rate || b.score - a.score);
                    const topResults = results.slice(0, 5); 
                    let introText = `ğŸ” å¹«æ‚¨æ‰¾åˆ° <b>${results.length}</b> ç­†ç›¸é—œå„ªæƒ `;
                    if(detectedIntent) introText += ` (å·²è‡ªå‹•æœå°‹ã€Œ${detectedIntent}ã€é¡åˆ¥)`;
                    introText += "ï¼š<br><br>";
                    replyHtml += introText;
                    topResults.forEach(r => {
                        replyHtml += `<div class="mb-3 pb-3 border-b border-slate-100 last:border-0 last:mb-0 last:pb-0">
                            <div class="flex justify-between items-start">
                                <div class="font-bold text-indigo-600 text-sm">ğŸ’³ ${r.bank} ${r.cardName}</div>
                                <span class="text-lg font-bold text-pink-500 flex-shrink-0">${r.rate}%</span>
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[10px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 font-bold">${r.category}</span>
                                ${r.reason ? `<span class="text-[9px] bg-yellow-50 text-orange-500 px-1.5 py-0.5 rounded font-bold border border-yellow-100">ğŸ’¡ å‘½ä¸­: ${r.reason}</span>` : ''}
                            </div>
                            <div class="text-xs text-slate-400 mt-1 leading-snug">${r.desc}</div>
                        </div>`;
                    });
                } else {
                    replyHtml += `ğŸ¤” å—š... é‡å°ã€Œ${msg}ã€æˆ‘æ‰¾ä¸åˆ°æ˜ç¢ºçš„å„ªæƒ è³‡æ–™è€¶ã€‚<br><br>è©¦è©¦çœ‹æœå°‹åˆ¥çš„ï¼Ÿä¾‹å¦‚ï¼šã€Œé¤å»³ã€ã€ã€Œç¶²è³¼ã€ã€‚`;
                }

                chatBox.innerHTML += `<div class="flex gap-3 mb-4"><div class="w-8 h-8 rounded-full bg-gradient-to-br from-pink-400 to-rose-400 flex items-center justify-center text-white flex-shrink-0"><i data-lucide="bot" class="w-4 h-4"></i></div><div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 max-w-[85%]">${replyHtml}</div></div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
                lucide.createIcons();
            }, 800);
        }

        window.onSmallPayInput = function(val) {
            const input = val.trim().toLowerCase();
            const suggestionsBox = document.getElementById('smallPaySuggestions');
            const resultDiv = document.getElementById('smallPayResult');
            if (input.length < 1) { suggestionsBox.classList.add('hidden'); resultDiv.classList.add('hidden'); return; }
            const matches = SMALL_PAYMENT_STORES_DB.filter(s => s.name.toLowerCase().includes(input)).slice(0, 15);
            if (matches.length > 0) {
                let html = '';
                matches.forEach(m => {
                    const regex = new RegExp(`(${val})`, 'gi');
                    const highlight = m.name.replace(regex, '<span class="suggestion-match">$1</span>');
                    html += `<div class="suggestion-item" onclick="selectSuggestion('${m.name}')"><span class="truncate pr-2">${highlight}</span><span class="suggestion-city whitespace-nowrap">${m.city}</span></div>`;
                });
                suggestionsBox.innerHTML = html;
                suggestionsBox.classList.remove('hidden');
            } else { suggestionsBox.classList.add('hidden'); }
        }
        window.selectSuggestion = function(val) { document.getElementById('smallPayInput').value = val; document.getElementById('smallPaySuggestions').classList.add('hidden'); checkSmallPay(val); }
        window.clearSmallPaySearch = function() { document.getElementById('smallPayInput').value = ''; document.getElementById('smallPaySuggestions').classList.add('hidden'); document.getElementById('smallPayResult').classList.add('hidden'); }
        window.checkSmallPay = function(inputVal) {
            const input = inputVal || document.getElementById('smallPayInput').value.trim();
            const resultDiv = document.getElementById('smallPayResult');
            if(!input) { resultDiv.classList.add('hidden'); return; }
            const match = SMALL_PAYMENT_STORES_DB.find(s => s.name === input || s.name.includes(input));
            resultDiv.classList.remove('hidden');
            if(match) { resultDiv.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-xl p-4 flex gap-3 items-start animate-pulse"><i data-lucide="alert-triangle" class="w-6 h-6 text-red-500 flex-shrink-0 mt-0.5"></i><div><h3 class="font-bold text-red-600 text-lg mb-1">é€™æ˜¯å°é¡æ”¯ä»˜å¹³å°ï¼</h3><p class="text-xs text-red-500 font-bold leading-relaxed">ã€Œ${match.name}ã€(${match.city}) å±¬æ–¼å°é¡æ”¯ä»˜åå–®ã€‚<br>âš ï¸ ç›´æ¥åˆ·å¡å¯èƒ½<span class="underline">ç„¡å›é¥‹</span>ã€‚<br><span class="text-[10px] text-slate-400 mt-1 block">åœ°å€: ${match.address}</span></p></div></div>`; } 
            else { const isChain = SMALL_PAYMENT_CHAINS.some(c => input.includes(c)); if(isChain) { resultDiv.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-xl p-4"><h3 class="font-bold text-red-600 text-lg">âš ï¸ é€£é–åº—æ³¨æ„</h3><p class="text-xs text-red-500">æ­¤å“ç‰Œé€šå¸¸ç‚ºå°é¡æ”¯ä»˜ï¼Œè«‹ç¢ºèªã€‚</p></div>`; } else { resultDiv.innerHTML = `<div class="bg-emerald-50 border border-emerald-200 rounded-xl p-4 flex gap-3 items-start"><i data-lucide="check-circle-2" class="w-6 h-6 text-emerald-500 flex-shrink-0 mt-0.5"></i><div><h3 class="font-bold text-emerald-600 text-lg mb-1">æœªåˆ—åœ¨åå–®ä¸­</h3><p class="text-xs text-emerald-500 font-bold leading-relaxed">è³‡æ–™åº«ç„¡ã€Œ${input}ã€ç´€éŒ„ã€‚<br>æ‡‰å¯äº«æœ‰å›é¥‹ã€‚</p></div></div>`; } }
            lucide.createIcons();
        }
        window.filterSmallPayByCity = function() {
            const city = document.getElementById('smallPayCitySelect').value;
            const resultDiv = document.getElementById('smallPayResult');
            if(!city) { resultDiv.classList.add('hidden'); return; }
            const localStores = SMALL_PAYMENT_STORES_DB.filter(s => s.city === city || s.city === 'å…¨å°');
            let html = `<div class="bg-white border border-slate-200 rounded-xl p-3 max-h-60 overflow-y-auto space-y-2">`;
            if(localStores.length > 0) { localStores.forEach(s => { html += `<div class="flex justify-between items-center text-xs border-b border-slate-100 pb-2 last:border-0 last:pb-0"><span class="font-bold text-slate-700">${s.name}</span><span class="text-slate-400 text-[10px] truncate max-w-[150px]">${s.address}</span></div>`; }); } else { html += `<div class="text-center text-slate-400 py-4">ç„¡è³‡æ–™</div>`; }
            html += `</div>`; resultDiv.innerHTML = html; resultDiv.classList.remove('hidden');
        }
        function checkScroll() { const btn = document.getElementById('btnBackToTop'); if(window.scrollY > 200) btn.classList.add('show'); else btn.classList.remove('show'); }
        window.addEventListener('scroll', checkScroll);
        function getCycleRange(settings, refDate) { const year = refDate.getFullYear(), month = refDate.getMonth(), day = refDate.getDate(); let start, end; if (settings.cycleType === 'month') { start = new Date(year, month, 1); end = new Date(year, month + 1, 0); } else { const billDay = parseInt(settings.billDay) || 1; if (day > billDay) { start = new Date(year, month, billDay + 1); end = new Date(year, month + 1, billDay); } else { start = new Date(year, month - 1, billDay + 1); end = new Date(year, month, billDay); } } return { start: start.toISOString().split('T')[0], end: end.toISOString().split('T')[0] }; }
        
        // --- RESTORED TRANSACTION FUNCTIONS ---
        window.openTransactionModal = function(existingTxId = null) {
            const select = document.getElementById('txCardSelect'); select.innerHTML = '';
            let sortedCards = [...allCardsData];
            if(manageCardFilter) { sortedCards.sort((a,b) => (a.id === manageCardFilter ? -1 : 1)); }

            sortedCards.forEach(c => { const opt = document.createElement('option'); opt.value = c.id; opt.text = `${c.bank} - ${c.name}`; select.appendChild(opt); });
            
            const btnDel = document.getElementById('btnDeleteTx');
            const title = document.getElementById('txModalTitle');

            if (existingTxId && typeof existingTxId === 'string') {
                const tx = transactions.find(t => t.id === existingTxId);
                if (tx) {
                    editingTransactionId = tx.id;
                    title.innerText = "ä¿®æ”¹æ¶ˆè²»ç´€éŒ„";
                    document.getElementById('txCardSelect').value = tx.cardId;
                    document.getElementById('txAmount').value = tx.amount;
                    document.getElementById('txDate').value = tx.date;
                    
                    if(tx.category) {
                         document.getElementById('txCategory').value = tx.category;
                         document.getElementById('txItem').value = tx.item || '';
                    } else {
                        document.getElementById('txCategory').value = "ğŸ“¦ å…¶ä»–";
                        document.getElementById('txItem').value = tx.item || '';
                    }

                    document.getElementById('txNote').value = tx.note || '';
                    document.getElementById('checkReward').checked = tx.types.includes('reward');
                    document.getElementById('checkGeneral').checked = tx.types.includes('general');
                    
                    btnDel.classList.remove('hidden');
                    btnDel.onclick = function() { window.openDeleteConfirm(); };
                }
            } else {
                editingTransactionId = null;
                title.innerText = "è¨˜ä¸€ç­†æ¶ˆè²»";
                document.getElementById('txAmount').value = '';
                document.getElementById('txCategory').value = "ğŸ½ï¸ é¤é£²"; 
                document.getElementById('txItem').value = '';
                document.getElementById('txNote').value = '';
                document.getElementById('checkReward').checked = true;
                document.getElementById('checkGeneral').checked = false;
                document.getElementById('txDate').valueAsDate = new Date();
                
                if(currentView === 'manage' && manageCardFilter) {
                     document.getElementById('txCardSelect').value = manageCardFilter;
                }
                
                btnDel.classList.add('hidden');
            }
            document.getElementById('transactionModal').classList.remove('hidden');
        }
        window.closeTransactionModal = function() { document.getElementById('transactionModal').classList.add('hidden'); }
        
        window.saveTransaction = async function() {
            const cardId = document.getElementById('txCardSelect').value;
            const amount = parseFloat(document.getElementById('txAmount').value);
            const date = document.getElementById('txDate').value;
            const category = document.getElementById('txCategory').value;
            const item = document.getElementById('txItem').value; 
            const note = document.getElementById('txNote').value;
            const types = [];
            if(document.getElementById('checkReward').checked) types.push('reward');
            if(document.getElementById('checkGeneral').checked) types.push('general');

            if (!cardId || !amount || !date || !category) return alert("è«‹å¡«å¯«é‡‘é¡ã€æ—¥æœŸèˆ‡é¡åˆ¥");
            
            showLoading(true, "é›²ç«¯åŒæ­¥ä¸­...");
            await new Promise(r => setTimeout(r, 50));

            let txData = { cardId, amount, date, category, item, note, types, timestamp: Date.now() };

            if (editingTransactionId) {
                const index = transactions.findIndex(t => t.id === editingTransactionId);
                if (index !== -1) {
                    txData.id = editingTransactionId;
                    transactions[index] = txData;
                }
            } else {
                txData.id = Date.now().toString();
                transactions.push(txData);
            }

            localStorage.setItem('cc_transactions_v2', JSON.stringify(transactions));
            await postToCloud(txData, 'save'); 
            
            showLoading(false); 
            showToast('âœ… å·²æ›´æ–°');
            closeTransactionModal();
            renderView();
            if(!document.getElementById('historyModal').classList.contains('hidden')) window.openHistoryModal();
        }

        // --- RESTORED DELETE & HISTORY & SETTINGS ---
        window.openDeleteConfirm = function() {
            document.getElementById('deleteConfirmModal').classList.remove('hidden');
        }

        window.executeDelete = async function() {
            document.getElementById('deleteConfirmModal').classList.add('hidden'); 
            showLoading(true, "é›²ç«¯åˆªé™¤ä¸­...");
            
            transactions = transactions.filter(t => t.id !== editingTransactionId);
            localStorage.setItem('cc_transactions_v2', JSON.stringify(transactions));
            
            await postToCloud({id: editingTransactionId}, 'delete'); 
            
            showToast('âœ… åˆªé™¤æˆåŠŸ');
            showLoading(false);
            closeTransactionModal();
            renderView();
            if(!document.getElementById('historyModal').classList.contains('hidden')) window.openHistoryModal();
        }

        window.openHistoryModal = function() {
            const list = document.getElementById('historyListContainer');
            list.innerHTML = '';
            document.getElementById('historyModal').classList.remove('hidden');
            const sortedTx = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            document.getElementById('historyTotalDisplay').innerText = `ç¸½è¨ˆ $${sortedTx.reduce((s,t)=>s+parseFloat(t.amount),0).toLocaleString()}`;
            if(sortedTx.length === 0) { list.innerHTML = `<div class="text-center text-slate-300 py-20 font-bold">å°šç„¡ç´€éŒ„</div>`; return; }
            const groups = {};
            sortedTx.forEach(tx => { const month = tx.date.substring(0, 7); if (!groups[month]) groups[month] = []; groups[month].push(tx); });
            Object.keys(groups).sort().reverse().forEach(month => {
                const monthDiv = document.createElement('div');
                monthDiv.className = "mb-6";
                monthDiv.innerHTML = `<div class="text-lg font-bold text-slate-800 serif-font mb-3 pl-1 border-l-4 border-indigo-400 flex items-center gap-2">${month.split('-')[0]}å¹´ <span class="text-indigo-600">${month.split('-')[1]}æœˆ</span></div>`;
                groups[month].forEach(tx => {
                    const card = allCardsData.find(c => c.id === tx.cardId) || { name: 'æœªçŸ¥å¡ç‰‡' };
                    let badges = '';
                    if(tx.types.includes('reward')) badges += '<span class="text-[9px] bg-indigo-50 text-indigo-500 px-1.5 py-0.5 rounded font-bold">å›é¥‹</span>';
                    if(tx.types.includes('general')) badges += '<span class="text-[9px] bg-orange-50 text-orange-500 px-1.5 py-0.5 rounded font-bold">ä½æ¶ˆ</span>';
                    const item = document.createElement('div');
                    item.className = "flex justify-between items-center bg-white p-3 rounded-xl shadow-sm border border-slate-100 mb-2 tx-row";
                    item.onclick = function() { window.openTransactionModal(tx.id); };
                    
                    const catStr = tx.category ? `<span class="mr-1">${tx.category.split(' ')[0]}</span>` : '';
                    const itemStr = tx.item || tx.note || 'æ¶ˆè²»';

                    item.innerHTML = `<div class="flex items-center gap-3"><div class="text-xs font-bold text-slate-400 font-mono w-8 text-center">${tx.date.slice(8,10)}æ—¥</div><div><div class="text-xs text-slate-600 font-medium">${card.name}</div><div class="font-bold text-slate-700 text-sm">${catStr}${itemStr}</div></div></div><div class="text-right"><div class="font-bold text-slate-700 font-mono">$${parseFloat(tx.amount).toLocaleString()}</div><div class="flex gap-1 justify-end mt-1">${badges}</div></div>`;
                    monthDiv.appendChild(item);
                });
                list.appendChild(monthDiv);
            });
        }

        window.closeHistoryModal = function() { document.getElementById('historyModal').classList.add('hidden'); renderView(); }
        window.openSettingsModal = function(cardId, name) {
            editingCardId = cardId;
            const s = cardSettings[cardId] || { cycleType: 'month', billDay: 1, customCap: '', customMin: '' };
            let displayCap = s.customCap;
            if(!displayCap) { const def = getCardDefaultCap(cardId); if(def > 0) displayCap = def; }
            document.getElementById('settingCardTitle').innerText = name;
            document.getElementById('settingCap').value = displayCap || '';
            document.getElementById('settingMin').value = s.customMin || '';
            setCycleMode(s.cycleType || 'month');
            document.getElementById('settingBillDay').value = s.billDay || 1;
            document.getElementById('settingsModal').classList.remove('hidden');
        }
        window.closeSettingsModal = function() { document.getElementById('settingsModal').classList.add('hidden'); editingCardId = null; }
        window.setCycleMode = function(mode) {
            const btnMonth = document.getElementById('btnCycleMonth');
            const btnBill = document.getElementById('btnCycleBill');
            const inputGroup = document.getElementById('billDateInputGroup');
            if (mode === 'month') {
                btnMonth.className = "flex-1 py-2 text-xs font-bold rounded-lg border bg-indigo-500 text-white border-transparent shadow-md";
                btnBill.className = "flex-1 py-2 text-xs font-bold rounded-lg border border-slate-200 text-slate-500 bg-white";
                inputGroup.classList.add('hidden');
            } else {
                btnBill.className = "flex-1 py-2 text-xs font-bold rounded-lg border bg-indigo-500 text-white border-transparent shadow-md";
                btnMonth.className = "flex-1 py-2 text-xs font-bold rounded-lg border border-slate-200 text-slate-500 bg-white";
                inputGroup.classList.remove('hidden');
            }
            document.getElementById('settingsModal').dataset.mode = mode;
        }
        window.saveCardSettings = function() {
            if (!editingCardId) return;
            const mode = document.getElementById('settingsModal').dataset.mode;
            const billDay = parseInt(document.getElementById('settingBillDay').value);
            const cap = document.getElementById('settingCap').value;
            const min = document.getElementById('settingMin').value;
            cardSettings[editingCardId] = { cycleType: mode, billDay, customCap: cap, customMin: min };
            localStorage.setItem('cc_card_settings', JSON.stringify(cardSettings));
            closeSettingsModal();
            renderView();
        }

        document.getElementById('bankSelect').addEventListener('change', (e) => { currentBankFilter = e.target.value; currentCardFilter = ''; const s=document.getElementById('cardSelect'); s.innerHTML='<option value="">æ‰€æœ‰å¡ç‰‡</option>'; if(currentBankFilter) { allCardsData.filter(c=>c.bank===currentBankFilter).forEach(c=>{const o=document.createElement('option');o.value=c.name;o.text=c.name;s.appendChild(o)});s.disabled=false;}else s.disabled=true; renderView(); });
        document.getElementById('cardSelect').addEventListener('change', (e) => { currentCardFilter = e.target.value; renderView(); });
        document.getElementById('manageCardFilter').addEventListener('change', (e) => { manageCardFilter = e.target.value; renderView(); });
        document.getElementById('searchInput').addEventListener('input', (e) => { document.getElementById('clearBtn').style.display = e.target.value ? 'block' : 'none'; if(currentView === 'search') renderView(); });
        document.getElementById('clearBtn').addEventListener('click', () => { document.getElementById('searchInput').value = ''; document.getElementById('clearBtn').style.display = 'none'; renderView(); });

        init();
    </script>
</body>
</html>