<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ¯›çˆ¸æ¯›åª½çš„ä¿¡ç”¨å¡æ¬Šç›Š V104 (Fix Delete & Edit)</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ¯›çˆ¸æ¯›åª½æ¬Šç›Š">
    
    <!-- Custom Icon -->
    <link rel="icon" type="image/jpeg" href="https://drive.google.com/thumbnail?id=1wV-Acpnvj_3CXb_BHx4HPkLiLeqA6ItS&sz=s256">
    <link rel="apple-touch-icon" href="https://drive.google.com/thumbnail?id=1wV-Acpnvj_3CXb_BHx4HPkLiLeqA6ItS&sz=s256">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { aurora: { primary: '#6366F1', accent: '#EC4899' } },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'], serif: ['"Noto Serif TC"', 'serif'] },
                    boxShadow: { 'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)' },
                    animation: { 'shake': 'shake 0.82s cubic-bezier(.36,.07,.19,.97) both' },
                    keyframes: { shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } } }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); background-attachment: fixed; min-height: 100vh; overscroll-behavior-y: none; padding-bottom: env(safe-area-inset-bottom); }
        h1, h2, h3, .serif-font { font-family: 'Noto Serif TC', serif; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .custom-checkbox input:checked + div { background-color: #6366F1; border-color: #6366F1; color: white; }
        .tab-btn { color: #94A3B8; transition: all 0.3s; }
        .tab-btn.active { color: #6366F1; transform: translateY(-2px); }
        .fab { background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        .loading-overlay { background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); z-index: 100; }
        button { pointer-events: auto; }
        .tx-row { transition: background-color 0.2s; cursor: pointer; }
        .tx-row:active { background-color: #F1F5F9; transform: scale(0.98); }
        .bank-badge { display: inline-block; padding: 0.35rem 0.8rem; border-radius: 9999px; color: white; font-weight: bold; font-size: 0.75rem; box-shadow: 0 2px 6px rgba(0,0,0,0.15); letter-spacing: 0.5px; }
        .input-box-fixed { background-color: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 1.2rem; padding: 0.75rem 1rem; display: flex; align-items: center; width: 100%; }
        select { -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394A3B8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 1rem center; background-size: 1em; border-radius: 1rem; }
        
        .float-btn-group { position: fixed; bottom: 85px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 45; }
        .float-mini-btn { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .btn-top { background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); color: #6366F1; opacity: 0; transform: translateY(10px); pointer-events: none; border: 1px solid #EEF2FF; }
        .btn-top.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .btn-bot { background: linear-gradient(135deg, #EC4899 0%, #F43F5E 100%); box-shadow: 0 4px 12px rgba(236, 72, 153, 0.4); color: white; transform: scale(0); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .btn-bot.show { transform: scale(1); }
        .btn-bot:active { transform: scale(0.9); }

        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        .toggle-switch { position: relative; width: 40px; height: 22px; background: #CBD5E0; border-radius: 20px; transition: 0.3s; }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; background: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .toggle-checked { background: #6366F1; }
        .toggle-checked::after { transform: translateX(18px); }
        
        .suggestions-box { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #E2E8F0; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); z-index: 50; max-height: 250px; overflow-y: auto; margin-top: 4px; }
        .suggestion-item { padding: 0.75rem 1rem; cursor: pointer; font-size: 0.875rem; color: #475569; border-bottom: 1px solid #F1F5F9; display:flex; justify-content:space-between; align-items:center; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #F8FAFC; color: #6366F1; font-weight: bold; }
        
        .pin-dot { width: 12px; height: 12px; border-radius: 50%; background-color: #CBD5E0; margin: 0 4px; transition: background-color 0.2s; }
        .pin-dot.active { background-color: #6366F1; }
        
        /* Drag and Drop Style */
        .sortable-ghost { opacity: 0.4; background-color: #F1F5F9; }
        .sortable-drag { cursor: grabbing; background: white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="pb-24 text-slate-700">

    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 z-[100] bg-gradient-to-br from-indigo-50 to-pink-50 flex flex-col items-center justify-center p-6 transition-all duration-500">
        <div class="bg-white/80 backdrop-blur-xl p-8 rounded-[2rem] shadow-xl w-full max-w-xs text-center border border-white/50">
            <h1 class="text-2xl font-bold text-slate-800 mb-2 serif-font">æ­¡è¿å›ä¾†</h1>
            <p class="text-xs text-slate-400 mb-8">è«‹é¸æ“‡èº«åˆ†ä»¥è§£é–</p>
            <div id="userSelectArea" class="grid grid-cols-2 gap-4 mb-6">
                <button onclick="promptPin('Lynn')" class="flex flex-col items-center gap-3 p-4 rounded-2xl border-2 border-transparent bg-white shadow-sm hover:border-pink-300 transition-all hover:-translate-y-1 active:scale-95 group">
                    <div class="w-16 h-16 rounded-full bg-pink-100 flex items-center justify-center text-4xl shadow-inner group-hover:scale-110 transition-transform">ğŸ±</div><span class="font-bold text-slate-600">Lynn</span>
                </button>
                <button onclick="promptPin('Andy')" class="flex flex-col items-center gap-3 p-4 rounded-2xl border-2 border-transparent bg-white shadow-sm hover:border-blue-300 transition-all hover:-translate-y-1 active:scale-95 group">
                    <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-4xl shadow-inner group-hover:scale-110 transition-transform">ğŸ¦</div><span class="font-bold text-slate-600">Andy</span>
                </button>
            </div>
            <div id="pinArea" class="hidden">
                <div class="flex items-center justify-center gap-2 mb-6"><div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center text-2xl shadow-sm" id="pinUserIcon"></div><span class="font-bold text-lg text-slate-700" id="pinUserName"></span></div>
                <div class="flex justify-center mb-6" id="pinDots"><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div></div>
                <div class="grid grid-cols-3 gap-3 mb-4">
                    <button onclick="addPin(1)" class="py-3 rounded-2xl bg-slate-50 font-bold text-lg shadow-sm hover:bg-white active:bg-indigo-50">1</button>
                    <button onclick="addPin(2)" class="py-3 rounded-2xl bg-slate-50 font-bold text-lg shadow-sm hover:bg-white active:bg-indigo-50">2</button>
                    <button onclick="addPin(3)" class="py-3 rounded-2xl bg-slate-50 font-bold text-lg shadow-sm hover:bg-white active:bg-indigo-50">3</button>
                    <button onclick="addPin(4)" class="py-3 rounded-2xl bg-slate-50 font-bold text-lg shadow-sm hover:bg-white active:bg-indigo-50">4</button>
                    <button onclick="addPin(5)" class="py-3 rounded-2xl bg-slate-50 font-bold text-lg shadow-sm hover:bg-white active:bg-indigo-50">5</button>
                    <button onclick="addPin(6)" class="py-3 rounded-2xl bg-slate-50 font-bold text-lg shadow-sm hover:bg-white active:bg-indigo-50">6</button>
                    <button onclick="addPin(7)" class="py-3 rounded-2xl bg-slate-50 font-bold text-lg shadow-sm hover:bg-white active:bg-indigo-50">7</button>
                    <button onclick="addPin(8)" class="py-3 rounded-2xl bg-slate-50 font-bold text-lg shadow-sm hover:bg-white active:bg-indigo-50">8</button>
                    <button onclick="addPin(9)" class="py-3 rounded-2xl bg-slate-50 font-bold text-lg shadow-sm hover:bg-white active:bg-indigo-50">9</button>
                    <button onclick="resetPinUI()" class="py-3 rounded-2xl text-slate-400 font-bold text-xs">å–æ¶ˆ</button>
                    <button onclick="addPin(0)" class="py-3 rounded-2xl bg-slate-50 font-bold text-lg shadow-sm hover:bg-white active:bg-indigo-50">0</button>
                    <button onclick="deletePin()" class="py-3 rounded-2xl text-indigo-500"><i data-lucide="delete" class="w-6 h-6 mx-auto"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="appContainer" class="hidden opacity-0 transition-opacity duration-500">
        <!-- Toast updated for background sync status -->
        <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full text-xs font-bold shadow-lg z-[80] transition-opacity duration-300 opacity-0 pointer-events-none">âœ… å·²æ›´æ–°</div>
        <div id="loadingOverlay" class="fixed inset-0 loading-overlay hidden flex flex-col items-center justify-center">
            <div class="relative w-16 h-16 mb-4"><div class="absolute inset-0 border-4 border-indigo-100 rounded-full"></div><div class="absolute inset-0 border-4 border-indigo-500 rounded-full border-t-transparent animate-spin"></div><i data-lucide="cloud-upload" class="absolute inset-0 m-auto w-6 h-6 text-indigo-500 animate-pulse"></i></div><span class="text-sm font-bold text-indigo-600 tracking-widest animate-pulse" id="loadingText">é›²ç«¯åŒæ­¥ä¸­...</span>
        </div>

        <!-- Header -->
        <div class="sticky top-0 z-30 bg-white/80 backdrop-blur-md shadow-sm border-b border-white/50 transition-all duration-300" style="padding-top: env(safe-area-inset-top);">
            <div class="max-w-md mx-auto px-5 py-4">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-2">
                        <h1 class="text-indigo-600 text-xl font-bold flex items-center gap-2 tracking-wide" onclick="window.scrollTo({top:0, behavior:'smooth'})"><i data-lucide="paw-print" class="w-5 h-5 text-pink-500"></i> <span id="appTitle">æ¯›çˆ¸æ¯›åª½çš„ä¿¡ç”¨å¡æ¬Šç›Š</span></h1>
                        <span id="userBadge" class="text-xs px-2.5 py-1 rounded-full bg-slate-100 text-slate-500 font-bold hidden shadow-sm border border-slate-200"></span>
                        <!-- Sync indicator -->
                        <div id="syncIndicator" class="hidden w-2 h-2 rounded-full bg-indigo-500 animate-pulse" title="èƒŒæ™¯åŒæ­¥ä¸­"></div>
                    </div>
                    <div id="totalSpendDisplay" class="text-slate-500 text-xs font-bold bg-indigo-50 px-3 py-1.5 rounded-full border border-indigo-100 hidden">æœ¬æœŸ $0</div>
                </div>
                
                <div id="headerControls" class="mt-2 space-y-3">
                    <div class="relative bg-white rounded-xl shadow-sm border border-indigo-50 flex items-center"><i data-lucide="search" class="absolute left-3 w-4 h-4 text-indigo-300"></i><input type="text" id="searchInput" placeholder="æœå°‹æ¬Šç›Šã€é¤å»³ã€å„ªæƒ ..." class="w-full pl-10 pr-10 py-3 rounded-xl border-none outline-none bg-transparent text-slate-700 placeholder-indigo-200 text-sm font-medium"><button id="clearBtn" class="absolute right-3 hidden text-slate-400 hover:text-indigo-500 p-1"><i data-lucide="x" class="w-4 h-4"></i></button></div>
                    <div id="quickSelectContainer" class="grid grid-cols-2 gap-3 fade-in"><div class="relative"><select id="bankSelect" class="w-full bg-white/60 border border-white/60 rounded-xl py-2 pl-3 pr-8 text-xs font-bold text-slate-600 outline-none focus:ring-1 focus:ring-indigo-300"><option value="">æ‰€æœ‰éŠ€è¡Œ</option></select></div><div class="relative"><select id="cardSelect" class="w-full bg-white/60 border border-white/60 rounded-xl py-2 pl-3 pr-8 text-xs font-bold text-slate-600 outline-none disabled:opacity-50 focus:ring-1 focus:ring-indigo-300" disabled><option value="">æ‰€æœ‰å¡ç‰‡</option></select></div></div>
                </div>
                <div id="manageControls" class="mt-2 hidden fade-in space-y-3">
                     <div class="flex items-center justify-between gap-2">
                        <div class="flex items-center gap-2 cursor-pointer bg-indigo-50/50 p-2.5 rounded-xl border border-indigo-50 flex-1" onclick="toggleActiveOnly()">
                            <div id="toggleActiveSwitch" class="toggle-switch flex-shrink-0"></div>
                            <span class="text-xs font-bold text-slate-600">åƒ…é¡¯ç¤ºæ¶ˆè²»ä¿¡ç”¨å¡</span>
                        </div>
                        <button onclick="document.getElementById('cloudModal').classList.remove('hidden')" class="w-11 h-11 flex items-center justify-center bg-white border border-indigo-50 rounded-xl text-indigo-400 shadow-sm hover:text-indigo-600 active:scale-95 transition"><i data-lucide="settings" class="w-5 h-5"></i></button>
                     </div>
                    <div class="flex gap-2">
                        <div class="relative flex-1"><select id="manageCardFilter" class="w-full bg-white/90 border border-indigo-100 rounded-xl py-2.5 pl-3 pr-8 text-xs font-bold text-slate-600 outline-none shadow-sm focus:ring-2 focus:ring-indigo-200"><option value="">ğŸ’³ æ‰€æœ‰ä¿¡ç”¨å¡</option></select></div>
                        <button onclick="openCardSortModal()" class="flex-none w-11 h-11 bg-white border border-indigo-50 text-indigo-500 rounded-xl shadow-sm flex items-center justify-center active:scale-95 transition-transform hover:bg-indigo-50"><i data-lucide="list-ordered" class="w-5 h-5"></i></button>
                        <button onclick="window.openHistoryModal()" class="flex-none px-4 py-2.5 bg-indigo-500 text-white rounded-xl shadow-md text-xs font-bold flex items-center gap-1 active:scale-95 transition-transform hover:bg-indigo-600"><i data-lucide="receipt" class="w-4 h-4"></i> æ­·å²å¸³æœ¬</button>
                    </div>
                </div>
                <div id="smallPayControls" class="hidden fade-in mt-2 space-y-3"><div class="bg-white p-4 rounded-2xl border border-orange-100 shadow-sm relative"><div class="flex justify-between items-start mb-2"><div class="flex items-center gap-2"><i data-lucide="shield-alert" class="w-5 h-5 text-orange-500"></i><h2 class="text-sm font-bold text-slate-800">å°é¡æ”¯ä»˜å¹³å°æŸ¥è©¢</h2></div><button onclick="document.getElementById('smallPayDbModal').classList.remove('hidden')" class="text-[10px] text-indigo-500 underline">æ‰‹å‹•åŒ¯å…¥</button></div><div class="relative mb-3"><div class="relative bg-slate-50 rounded-xl shadow-inner border border-slate-200 flex items-center"><i data-lucide="search" class="absolute left-3 w-4 h-4 text-slate-400"></i><input type="text" id="smallPayInput" placeholder="è¼¸å…¥å“ç‰Œ (å¦‚: é¶´èŒ¶æ¨“)..." autocomplete="off" class="w-full pl-10 pr-10 py-3 rounded-xl border-none outline-none bg-transparent text-slate-700 placeholder-slate-400 text-sm font-bold" oninput="onSmallPayInput(this.value)"><button onclick="clearSmallPaySearch()" class="absolute right-3 text-slate-300 hover:text-slate-500 p-1"><i data-lucide="x" class="w-4 h-4"></i></button></div><div id="smallPaySuggestions" class="suggestions-box hidden"></div></div><div class="relative"><select id="smallPayCitySelect" onchange="filterSmallPayByCity()" class="w-full bg-orange-50/50 border border-orange-100 rounded-xl py-2.5 pl-3 pr-8 text-xs font-bold text-slate-600 outline-none focus:ring-2 focus:ring-orange-200"><option value="">ğŸ™ï¸ ä¾ç¸£å¸‚æŸ¥è©¢åº—å®¶</option></select></div></div><div id="smallPayResult" class="hidden animate-in fade-in slide-in-from-top-2"></div><div class="text-[10px] text-slate-300 text-center mt-2" id="smallPayStats">è³‡æ–™è¼‰å…¥ä¸­...</div></div>
            </div>
        </div>

        <!-- Floating Buttons -->
        <div class="float-btn-group">
            <button id="btnAiBot" onclick="openAiChat()" class="float-mini-btn btn-bot hidden"><i data-lucide="bot" class="w-6 h-6"></i></button>
            <button id="btnBackToTop" onclick="window.scrollTo({top:0, behavior:'smooth'})" class="float-mini-btn btn-top"><i data-lucide="arrow-up" class="w-5 h-5"></i></button>
        </div>

        <div id="mainContent" class="max-w-md mx-auto px-4 pt-4 space-y-5 min-h-[60vh]"></div>
        <div id="noResult" class="hidden text-center py-20 opacity-60"><div class="bg-white/50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm backdrop-blur-sm"><i data-lucide="cloud-off" class="w-10 h-10 text-indigo-200"></i></div><p class="text-indigo-400 font-bold text-sm tracking-widest">æš«ç„¡ç¬¦åˆè³‡æ–™</p></div>

        <div class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-xl border-t border-indigo-50 z-40 pb-[env(safe-area-inset-bottom)]">
            <div class="max-w-md mx-auto grid grid-cols-3 h-16 relative"> 
                <button onclick="switchTab('search')" class="tab-btn flex flex-col items-center justify-center gap-1" id="btnSearch"><i data-lucide="library" class="w-5 h-5"></i><span class="text-[10px] font-bold tracking-wide">æ¬Šç›ŠæŸ¥è©¢</span></button>
                <button onclick="switchTab('manage')" class="tab-btn active flex flex-col items-center justify-center gap-1" id="btnManage"><i data-lucide="wallet-cards" class="w-5 h-5"></i><span class="text-[10px] font-bold tracking-wide">å¸³å‹™ç®¡ç†</span></button>
                <button onclick="switchTab('smallpay')" class="tab-btn flex flex-col items-center justify-center gap-1" id="btnSmallPay"><i data-lucide="shield-alert" class="w-5 h-5"></i><span class="text-[10px] font-bold tracking-wide">å°é¡æŸ¥è©¢</span></button>
                <div id="fabContainer" class="absolute left-1/2 -top-6 -translate-x-1/2 hidden fade-in z-50 pointer-events-auto" style="display:block;"><button onclick="openTransactionModal()" class="fab text-white w-14 h-14 rounded-full flex items-center justify-center transition-transform active:scale-95 group pointer-events-auto shadow-xl"><i data-lucide="plus" class="w-7 h-7"></i></button></div>
            </div>
        </div>
    </div> <!-- End App Container -->

    <!-- Modals -->
    <div id="aiChatModal" class="fixed inset-0 bg-slate-900/60 z-[70] hidden flex flex-col justify-end sm:justify-center backdrop-blur-sm">
        <div class="bg-white w-full sm:max-w-sm sm:mx-auto sm:rounded-3xl rounded-t-3xl h-[80vh] sm:h-[600px] flex flex-col shadow-2xl animate-in slide-in-from-bottom-10">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-pink-500 to-rose-500 text-white sm:rounded-t-3xl rounded-t-3xl"><div class="flex items-center gap-2"><i data-lucide="bot" class="w-6 h-6"></i><h3 class="font-bold">AI æ™ºèƒ½å®¢æœ</h3></div><button onclick="document.getElementById('aiChatModal').classList.add('hidden')" class="p-1 hover:bg-white/20 rounded-full transition"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="flex-1 p-4 overflow-y-auto space-y-4 bg-slate-50" id="aiChatContent"><div class="flex gap-3"><div class="w-8 h-8 rounded-full bg-gradient-to-br from-pink-400 to-rose-400 flex items-center justify-center text-white flex-shrink-0"><i data-lucide="bot" class="w-4 h-4"></i></div><div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 max-w-[80%]">ä½ å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ä¿¡ç”¨å¡å°å¹«æ‰‹ã€‚<br>å‘Šè¨´æˆ‘æ‚¨æƒ³æ¶ˆè²»çš„é …ç›®ï¼Œä¾‹å¦‚ï¼šã€Œæƒ³å–<b>50åµ</b>ã€ã€ã€Œè¦åƒ<b>è‚¯å¾·åŸº</b>ã€ã€ã€Œç¹³<b>ä¿è²»</b>ã€ï¼Œæˆ‘æœƒè‡ªå‹•å¹«æ‚¨æ‰¾é©åˆçš„å¡ç‰‡ï¼Œä¸¦å¹«æ‚¨æª¢æŸ¥æ˜¯å¦ç‚ºå°é¡æ”¯ä»˜å–”ï¼</div></div></div>
            <div class="p-4 bg-white border-t border-slate-100 flex gap-2 pb-[calc(1rem+env(safe-area-inset-bottom))]"><input type="text" id="aiInput" class="flex-1 bg-slate-100 border-none rounded-xl px-4 py-2.5 text-sm outline-none focus:ring-2 focus:ring-pink-200" placeholder="è¼¸å…¥ï¼šæˆ‘æƒ³å–å¯ä¸å¯..." onkeypress="if(event.key==='Enter') sendAiMessage()"><button onclick="sendAiMessage()" class="bg-pink-500 text-white p-2.5 rounded-xl hover:bg-pink-600 transition"><i data-lucide="send" class="w-4 h-4"></i></button></div>
        </div>
    </div>

    <!-- Card Sort Modal (Drag and Drop) -->
    <div id="cardSortModal" class="fixed inset-0 bg-slate-900/60 z-[65] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-sm shadow-2xl flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">èª¿æ•´ä¿¡ç”¨å¡é †åº</h3>
                <button onclick="document.getElementById('cardSortModal').classList.add('hidden')" class="p-1 hover:bg-slate-100 rounded-full"><i data-lucide="x" class="w-5 h-5 text-slate-400"></i></button>
            </div>
            <div class="p-2 bg-indigo-50 border-b border-indigo-100 text-center text-xs text-indigo-500 font-bold">ğŸ’¡ æŒ‰ä½å³å´ä¸‰æ¢ç·šå³å¯æ‹–æ›³</div>
            <div id="cardSortList" class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- Items injected by JS -->
            </div>
            <div class="p-4 border-t border-slate-100">
                <button onclick="document.getElementById('cardSortModal').classList.add('hidden'); showToast('è¨­å®šå·²å„²å­˜'); renderView();" class="w-full py-3 rounded-xl bg-indigo-600 text-white font-bold shadow-md">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <div id="cloudModal" class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl fade-in text-center">
            <h3 class="font-bold text-lg mb-4 text-slate-800 serif-font text-center">ä½¿ç”¨è€…è¨­å®š</h3>
            <div class="bg-indigo-50 p-4 rounded-xl mb-5 border border-indigo-100">
                <label class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-3 block text-center">é¸æ“‡æ‚¨çš„èº«åˆ†</label>
                <div class="grid grid-cols-2 gap-3">
                    <button id="btnUserLynn" onclick="switchUser('Lynn')" class="py-3 text-sm font-bold rounded-xl border border-slate-200 bg-white text-slate-500 hover:bg-pink-50 transition-all flex flex-col items-center gap-1 shadow-sm"><span class="text-2xl mb-1">ğŸ±</span> Lynn</button>
                    <button id="btnUserAndy" onclick="switchUser('Andy')" class="py-3 text-sm font-bold rounded-xl border border-slate-200 bg-white text-slate-500 hover:bg-blue-50 transition-all flex flex-col items-center gap-1 shadow-sm"><span class="text-2xl mb-1">ğŸ¦</span> Andy</button>
                </div>
            </div>
            <div class="space-y-3"><div><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1.5 block">è¨˜å¸³åŒæ­¥è³‡æ–™åº« (GAS)</label><input type="text" id="gasUrl" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-xs text-slate-600 outline-none" placeholder="https://script.google.com/..." readonly><p class="text-[9px] text-slate-300 mt-1">* ç³»çµ±è‡ªå‹•å¸¶å…¥ï¼Œç„¡éœ€ä¿®æ”¹</p></div></div>
            <div class="flex gap-2 mt-6"><button onclick="document.getElementById('cloudModal').classList.add('hidden')" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">é—œé–‰</button><button onclick="syncWithCloud(true)" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold shadow-md text-sm">ç«‹å³åŒæ­¥</button></div>
        </div>
    </div>

    <div id="smallPayDbModal" class="fixed inset-0 bg-slate-900/60 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl fade-in"><h3 class="font-bold text-lg mb-1 text-slate-800 serif-font">åŒ¯å…¥å°é¡æ”¯ä»˜å®Œæ•´åå–®</h3><p class="text-xs text-slate-400 mb-4">è²¼ä¸Š CSV ç¶²å€</p><input type="text" id="smallPayCsvUrl" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-xs text-slate-600 outline-none mb-2" placeholder="https://docs.google.com/..."><div class="flex gap-2"><button onclick="document.getElementById('smallPayDbModal').classList.add('hidden')" class="flex-1 py-2 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">å–æ¶ˆ</button><button onclick="saveSmallPayDb()" class="flex-1 py-2 rounded-xl bg-indigo-600 text-white font-bold shadow-md text-sm">åŒ¯å…¥</button></div></div></div>
    <div id="deleteConfirmModal" class="fixed inset-0 bg-slate-900/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl fade-in transform transition-all scale-100"><div class="flex flex-col items-center text-center mb-4"><div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-3"><i data-lucide="trash-2" class="w-6 h-6 text-red-500"></i></div><h3 class="font-bold text-lg text-slate-800">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h3><p class="text-xs text-slate-500 mt-1">åˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸã€‚</p></div><div class="flex gap-3"><button onclick="document.getElementById('deleteConfirmModal').classList.add('hidden')" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-600 font-bold text-sm">å–æ¶ˆ</button><button onclick="executeDelete()" class="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold shadow-md text-sm">ç¢ºèªåˆªé™¤</button></div></div></div>
    
    <!-- Transaction Modal -->
    <div id="transactionModal" class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm transition-opacity">
        <div class="bg-white w-full sm:max-w-sm rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-in slide-in-from-bottom-10 duration-300 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-slate-800 serif-font" id="txModalTitle">è¨˜ä¸€ç­†æ¶ˆè²»</h3><button onclick="closeTransactionModal()" class="bg-slate-100 p-2 rounded-full text-slate-500 hover:bg-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="space-y-4">
                <div><label class="text-xs font-bold text-slate-400 mb-1.5 block">é¸æ“‡å¡ç‰‡ <span class="text-red-400">*</span></label><select id="txCardSelect" class="w-full bg-slate-50 border-none rounded-xl p-3.5 text-slate-700 outline-none font-bold text-sm focus:ring-2 focus:ring-indigo-200"></select></div>
                <div class="flex gap-3"><div class="flex-1"><label class="text-xs font-bold text-slate-400 mb-1.5 block">é‡‘é¡ <span class="text-red-400">*</span></label><input type="number" id="txAmount" class="w-full bg-slate-50 border-none rounded-xl p-3.5 text-xl font-bold text-slate-800 outline-none focus:ring-2 focus:ring-indigo-200" placeholder="$0"></div><div class="w-1/3"><label class="text-xs font-bold text-slate-400 mb-1.5 block">æ—¥æœŸ <span class="text-red-400">*</span></label><input type="date" id="txDate" class="w-full bg-slate-50 border-none rounded-xl p-3.5 text-xs font-bold text-slate-600 outline-none focus:ring-2 focus:ring-indigo-200"></div></div>
                <div><label class="text-xs font-bold text-slate-400 mb-1.5 block">æ¶ˆè²»é¡åˆ¥ <span class="text-red-400">*</span></label><div class="relative"><select id="txCategory" class="w-full bg-slate-50 border-none rounded-xl p-3.5 text-sm font-bold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-200"></select></div></div>
                <div><label class="text-xs font-bold text-slate-400 mb-1.5 block">æ¶ˆè²»ç´°é … <span class="text-indigo-400 text-[10px]">(é¸å¡«)</span></label><input type="text" id="txItem" class="w-full bg-slate-50 border-none rounded-xl p-3.5 text-sm text-slate-700 outline-none focus:ring-2 focus:ring-indigo-200" placeholder="ä¾‹å¦‚ï¼šéº¥ç•¶å‹ã€å…¨è¯..."></div>
                <div><label class="text-xs font-bold text-slate-400 mb-1.5 block">æ¶ˆè²»é¡å‹</label><div class="flex gap-3"><label class="flex-1 cursor-pointer custom-checkbox"><input type="checkbox" id="checkReward" value="reward" class="hidden" checked><div class="border border-slate-200 rounded-xl py-3 text-center text-xs font-bold text-slate-500 transition-colors select-none">æŒ‡å®šå›é¥‹</div></label><label class="flex-1 cursor-pointer custom-checkbox"><input type="checkbox" id="checkGeneral" value="general" class="hidden"><div class="border border-slate-200 rounded-xl py-3 text-center text-xs font-bold text-slate-500 transition-colors select-none">ä¸€èˆ¬/ä½æ¶ˆ</div></label></div></div>
                <div><input type="text" id="txNote" class="w-full bg-transparent border-b border-slate-200 p-2 text-sm text-slate-600 outline-none placeholder-slate-300" placeholder="å‚™è¨» (é¸å¡«)..."></div>
                <!-- V79: Button logic managed by JS -->
                <div class="flex gap-3 mt-4 pt-2">
                    <button id="btnDeleteTx" class="hidden flex-1 py-3.5 rounded-xl border border-red-200 text-red-500 font-bold bg-red-50 hover:bg-red-100 transition-colors" onclick="openDeleteConfirm()">åˆªé™¤</button>
                    <button onclick="saveTransaction()" class="flex-[2] bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:shadow-indigo-200/50 transition-all active:scale-[0.98]">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- History & Settings Modals -->
    <!-- Updated History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-slate-50 z-50 hidden flex flex-col">
        <div class="bg-white border-b border-slate-100 p-4 flex justify-between items-center shadow-sm z-10 sticky top-0" style="padding-top: calc(1rem + env(safe-area-inset-top));">
            <div class="flex items-center gap-2">
                <button onclick="closeHistoryModal()" class="p-2 -ml-2 text-slate-400 hover:text-indigo-600"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                <h2 class="text-lg font-bold text-slate-800 serif-font">æ­·å²å¸³æœ¬</h2>
            </div>
            <!-- Month Selector -->
            <select id="historyMonthSelect" onchange="renderHistoryMonth()" class="bg-indigo-50 text-indigo-600 text-sm font-bold py-1.5 px-3 rounded-full outline-none border border-indigo-100">
                <!-- Options populated by JS -->
            </select>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4" id="historyListContainer">
            <!-- Chart Area -->
            <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wide">æœ¬æœˆç¸½æ”¯å‡º</p>
                        <h3 class="text-2xl font-bold text-slate-800" id="historyMonthTotal">$0</h3>
                    </div>
                </div>
                <div class="relative h-48 w-full flex justify-center">
                    <canvas id="historyPieChart"></canvas>
                </div>
            </div>
            <!-- List Area -->
            <div id="historyMonthList" class="space-y-3"></div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-slate-900/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl fade-in"><h3 class="font-bold text-lg mb-1 text-slate-800 serif-font">å¡ç‰‡è¨­å®š</h3><h4 class="text-sm text-indigo-500 font-bold mb-4 text-center" id="settingsCardName"></h4><div class="space-y-4 mt-2"><div><label class="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-1.5 block">æœ€ä½³å›é¥‹ä¸Šé™</label><div class="input-box-fixed"><span class="text-indigo-400 font-bold mr-2">$</span><input type="number" id="settingCap" class="flex-1 bg-transparent outline-none text-slate-700 font-bold text-lg h-6" placeholder="ç„¡ä¸Šé™"></div></div><div><label class="text-[10px] font-bold text-orange-400 uppercase tracking-widest mb-1.5 block">ä½æ¶ˆé–€æª»</label><div class="input-box-fixed"><span class="text-orange-400 font-bold mr-2">$</span><input type="number" id="settingMin" class="flex-1 bg-transparent outline-none text-slate-700 font-bold text-lg h-6" placeholder="0"></div></div><div class="bg-slate-50 p-4 rounded-2xl border border-slate-100"><label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 block">è¨ˆç®—é€±æœŸ</label><div class="flex gap-2 mb-3"><button type="button" onclick="setCycleMode('month')" id="btnCycleMonth" class="flex-1 py-2 text-xs font-bold rounded-lg border">æ—¥æ›†æœˆ</button><button type="button" onclick="setCycleMode('bill')" id="btnCycleBill" class="flex-1 py-2 text-xs font-bold rounded-lg border">çµå¸³æ—¥</button></div><div id="billDateInputGroup" class="hidden flex items-center gap-2 justify-center"><span class="text-xs text-slate-500 font-bold">æ¯æœˆ</span><input type="number" id="settingBillDay" min="1" max="31" class="w-14 text-center bg-white rounded-lg border border-slate-200 outline-none text-sm font-bold text-indigo-600 py-1.5" value="1"><span class="text-xs text-slate-500 font-bold">æ—¥ çµå¸³</span></div></div></div><div class="flex gap-3 mt-6"><button onclick="closeSettingsModal()" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">å–æ¶ˆ</button><button onclick="saveCardSettings()" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold shadow-md text-sm">ç¢ºèª</button></div></div></div>

    <script>
        // --- CONSTANTS ---
        const DEFAULT_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQhVkQJhNqPQAxXv-q0ethYeViFm69TyPnqRTmejQdwqgKtOvOLRbZ7toKBBTq7rWiqkQFMtGxvvWpC/pub?output=csv";
        const DEFAULT_SMALL_PAY_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSP7uOSfbfEnZx_TsDltCox5ubDR3f5ofOK7g-WEAp-y38coNSnY_VHfY1WuI8tqA/pub?output=csv";
        
        const USER_CONFIGS = {
            'Lynn': 'https://script.google.com/macros/s/AKfycbx4fis6JsM0YYp1KUzRb0xAPnhJPqIgR-MVtc8AGWjLjbFCXHWT5xW2JqAsGiw_B0d1IQ/exec',
            'Andy': 'https://script.google.com/macros/s/AKfycbzBHPtqIfPWxbAmF6B7yQYT8jd4btfJycPiihUhqpLZwMXNRTM5PUsgURumPvpsVMNXHA/exec'
        };

        const TX_CATEGORIES = ["ğŸ½ï¸ é¤é£²", "ğŸ¥¦ é£Ÿæ", "ğŸ›ï¸ è³¼ç‰©", "ğŸ¬ å¨›æ¨‚", "ğŸ’Š é†«ç™‚", "ğŸšŒ äº¤é€š", "â›½ åŠ æ²¹", "ğŸ¾ å¯µç‰©", "âœˆï¸ æ—…éŠ", "ğŸ›¡ï¸ ä¿éšª", "ğŸ“š èª²ç¨‹", "ğŸ’° ç¹³è²»", "ğŸ“¦ å…¶ä»–"];
        const TAIWAN_CITIES = ["å°åŒ—å¸‚", "æ–°åŒ—å¸‚", "åŸºéš†å¸‚", "æ¡ƒåœ’å¸‚", "æ–°ç«¹å¸‚", "æ–°ç«¹ç¸£", "è‹—æ —ç¸£", "å°ä¸­å¸‚", "å½°åŒ–ç¸£", "å—æŠ•ç¸£", "é›²æ—ç¸£", "å˜‰ç¾©å¸‚", "å˜‰ç¾©ç¸£", "å°å—å¸‚", "é«˜é›„å¸‚", "å±æ±ç¸£", "å®œè˜­ç¸£", "èŠ±è“®ç¸£", "å°æ±ç¸£"];
        
        let SMALL_PAYMENT_CHAINS = ["éº¥ç•¶å‹", "è‚¯å¾·åŸº", "æ¼¢å ¡ç‹", "æ‘©æ–¯", "7-11", "å…¨å®¶", "èŠçˆ¾å¯Œ", "OK", "50åµ", "æ¸…å¿ƒ", "CoCo", "å…¨è¯", "ç¾å»‰ç¤¾", "å…«æ–¹é›²é›†", "çˆ­é®®", "é›»è©±äº­KTV"];
        let SMALL_PAYMENT_STORES_DB = [];

        let allCardsData = [], uniqueBanks = [];
        let transactions = [];
        let cardSettings = {};
        let currentUser = localStorage.getItem('cc_current_user') || null;
        let API_URL = "";

        let currentView = 'manage'; 
        let showActiveOnly = false;
        let editingTransactionId = null;
        let currentBankFilter = '', currentCardFilter = '', manageCardFilter = '';
        let editingCardId = null;
        let tempPin = '';
        let pendingUser = '';
        let cardSortOrder = []; 
        let sortableInstance = null; // For Drag and Drop
        let historyChartInstance = null; // For ChartJS
        
        // --- ADDED FOR V94 ---
        let currentSmallPayResults = [];
        let currentSmallPayPage = 1;
        const SMALL_PAY_ITEMS_PER_PAGE = 20;

        const getStorageKey = (key) => currentUser ? `cc_${key}_${currentUser}` : null;

        // --- FIXED: INIT LOGIC ---
        function init() {
            loadSmallPayCsv(DEFAULT_SMALL_PAY_CSV_URL);
            
            document.getElementById('txDate').valueAsDate = new Date();
            initCategoryDropdown();
            initCityDropdown();

            // FIXED: Move checkLoginAndRender inside the callback
            Papa.parse(DEFAULT_CSV_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => { 
                    allCardsData = processRawData(results.data); 
                    initDropdowns(); 
                    // Only check login after card data is loaded to prevent empty renders
                    checkLoginAndRender();
                },
                error: () => { 
                    console.error("CSV Loaded Failed");
                    allCardsData = []; 
                    initDropdowns(); 
                    checkLoginAndRender();
                }
            });
        }
        
        function checkLoginAndRender() {
            currentUser = localStorage.getItem('cc_current_user'); // Refresh from local
            const app = document.getElementById('appContainer');
            const login = document.getElementById('loginScreen');

            if(currentUser) {
                switchUser(currentUser);
                app.classList.remove('hidden', 'opacity-0');
                login.classList.add('hidden');
                if(currentView === 'manage') switchTab('manage'); else renderView();
            } else {
                app.classList.add('hidden');
                login.classList.remove('hidden');
            }
        }
        
        // --- V87 Fix: Restore loadSmallPayCsv ---
        window.loadSmallPayCsv = function(url) {
            Papa.parse(url, {
                download: true, header: false, skipEmptyLines: true,
                complete: (results) => {
                    if (results.data && results.data.length > 0) {
                        const newStores = results.data.map(row => ({ name: row[0] || '', city: row[1] || 'å…¨å°', address: row[2] || '' })).filter(s => s.name && s.name !== "ç‰¹ç´„å•†åº—åç¨±");
                        // Add generics
                        SMALL_PAYMENT_CHAINS.forEach(c => newStores.push({ name: c, city: "å…¨å°", address: "å„åˆ†åº—" }));
                        // De-dup
                        const uniqueMap = new Map();
                        newStores.forEach(item => {
                            const key = item.name + (item.address || '');
                            if (!uniqueMap.has(key)) uniqueMap.set(key, item);
                        });
                        SMALL_PAYMENT_STORES_DB = Array.from(uniqueMap.values());
                        document.getElementById('smallPayStats').innerText = `è³‡æ–™åº«ï¼š${SMALL_PAYMENT_STORES_DB.length} ç­†åº—å®¶`;
                    }
                }
            });
        }
        
        window.checkScroll = function() { 
            const btn = document.getElementById('btnBackToTop'); 
            if(!btn) return;
            if(window.scrollY > 200) btn.classList.add('show'); 
            else btn.classList.remove('show'); 
        }
        window.addEventListener('scroll', checkScroll);

        // --- V81 Fix: User Switch ---
        window.switchUser = function(user) {
            currentUser = user;
            localStorage.setItem('cc_current_user', user);
            API_URL = USER_CONFIGS[user];
            
            // Re-load everything for new user
            cardSettings = JSON.parse(localStorage.getItem(getStorageKey('card_settings')) || '{}');
            transactions = JSON.parse(localStorage.getItem(getStorageKey('transactions')) || '[]');
            cardSortOrder = JSON.parse(localStorage.getItem(getStorageKey('card_order')) || '[]'); 
            
            // Update UI
            updateUserUI();
            document.getElementById('gasUrl').value = API_URL;
            
            // Visual feedback in modal
            const btnLynn = document.getElementById('btnUserLynn');
            const btnAndy = document.getElementById('btnUserAndy');
            
            if(btnLynn) btnLynn.className = user === 'Lynn' ? "py-3 text-sm font-bold rounded-xl border-2 border-pink-400 bg-pink-50 text-pink-600 transition-all flex flex-col items-center gap-1 shadow-sm" : "py-3 text-sm font-bold rounded-xl border border-slate-200 bg-white text-slate-500 hover:bg-pink-50 transition-all flex flex-col items-center gap-1 shadow-sm";
            if(btnAndy) btnAndy.className = user === 'Andy' ? "py-3 text-sm font-bold rounded-xl border-2 border-blue-400 bg-blue-50 text-blue-600 transition-all flex flex-col items-center gap-1 shadow-sm" : "py-3 text-sm font-bold rounded-xl border border-slate-200 bg-white text-slate-500 hover:bg-blue-50 transition-all flex flex-col items-center gap-1 shadow-sm";

            // Prune Old Data First
            pruneOldData();

            // Sync
            syncWithCloud(false); // False means don't block UI if cache exists
            renderView();
            showToast(`å·²åˆ‡æ›ç‚º ${user}`);
        }

        // --- FIXED: CLEANUP DATA (6 MONTHS) ---
        function pruneOldData() {
            if (!transactions || transactions.length === 0) return;
            const now = new Date();
            const cutoffDate = new Date(now.getFullYear(), now.getMonth() - 6, 1); // 6 months ago, 1st day
            
            const originalCount = transactions.length;
            const validTransactions = transactions.filter(t => {
                if (!t.date) return true; // Keep if date is missing to be safe
                const tDate = new Date(t.date);
                if (isNaN(tDate.getTime())) return true; // Keep invalid dates to prevent accidental deletion
                return tDate >= cutoffDate;
            });

            if (validTransactions.length < originalCount) {
                transactions = validTransactions;
                localStorage.setItem(getStorageKey('transactions'), JSON.stringify(transactions));
                console.log(`Pruned ${originalCount - validTransactions.length} old transactions.`);
            }
        }

        // --- LOGIN LOGIC ---
        window.promptPin = function(user) {
            pendingUser = user;
            tempPin = '';
            document.getElementById('userSelectArea').classList.add('hidden');
            document.getElementById('pinArea').classList.remove('hidden');
            document.getElementById('pinUserName').innerText = user;
            document.getElementById('pinUserIcon').innerText = user === 'Lynn' ? 'ğŸ±' : 'ğŸ¦';
            updatePinDots();
        }

        window.resetPinUI = function() {
            tempPin = '';
            document.getElementById('pinArea').classList.add('hidden');
            document.getElementById('userSelectArea').classList.remove('hidden');
        }

        window.addPin = function(num) {
            if(tempPin.length < 4) {
                tempPin += num;
                updatePinDots();
                if(tempPin.length === 4) checkPin();
            }
        }

        window.deletePin = function() {
            tempPin = tempPin.slice(0, -1);
            updatePinDots();
        }

        window.updatePinDots = function() {
            const dots = document.querySelectorAll('.pin-dot');
            dots.forEach((dot, index) => {
                if(index < tempPin.length) dot.classList.add('active');
                else dot.classList.remove('active');
            });
        }

        window.checkPin = function() {
            if(tempPin === '0515') {
                loginSuccess(pendingUser);
            } else {
                const pinArea = document.getElementById('pinArea');
                pinArea.classList.add('animate-shake');
                setTimeout(() => {
                    pinArea.classList.remove('animate-shake');
                    tempPin = '';
                    updatePinDots();
                }, 500);
            }
        }

        window.loginSuccess = function(user) {
            // Initial load calls switchUser to set up everything
            switchUser(user);
            
            document.getElementById('loginScreen').classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                switchTab('manage'); 
                setTimeout(() => document.getElementById('appContainer').classList.remove('opacity-0'), 50);
            }, 500);
        }

        window.logout = function() {
            document.getElementById('cloudModal').classList.add('hidden');
            document.getElementById('appContainer').classList.add('opacity-0');
            
            setTimeout(() => {
                document.getElementById('appContainer').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
                resetPinUI();
            }, 500);
            
            currentUser = null;
            transactions = [];
        }

        function loadUserData() {
            if (!currentUser) return;
            cardSettings = JSON.parse(localStorage.getItem(getStorageKey('card_settings')) || '{}');
            transactions = JSON.parse(localStorage.getItem(getStorageKey('transactions')) || '[]');
            cardSortOrder = JSON.parse(localStorage.getItem(getStorageKey('card_order')) || '[]'); 
            document.getElementById('gasUrl').value = API_URL;
            pruneOldData();
            syncWithCloud(false);
        }

        function updateUserUI() {
            const badge = document.getElementById('userBadge');
            if (currentUser === 'Lynn') {
                badge.innerText = "ğŸ± Lynn";
                badge.classList.remove('hidden');
            } else if (currentUser === 'Andy') {
                badge.innerText = "ğŸ¦ Andy";
                badge.classList.remove('hidden');
            }
        }

        // --- CORE FUNCTIONS (Standard) ---
        window.initCategoryDropdown = function() { const s = document.getElementById('txCategory'); s.innerHTML=''; TX_CATEGORIES.forEach(c => { const o = document.createElement('option'); o.value=c; o.text=c; s.appendChild(o); }); }
        window.initCityDropdown = function() { const s = document.getElementById('smallPayCitySelect'); s.innerHTML='<option value="">ğŸ™ï¸ ä¾ç¸£å¸‚æŸ¥è©¢åº—å®¶</option>'; TAIWAN_CITIES.forEach(c => { const o = document.createElement('option'); o.value=c; o.text=c; s.appendChild(o); }); }
        
        function getCycleRange(settings, refDate) { 
            const year = refDate.getFullYear(), month = refDate.getMonth(), day = refDate.getDate(); 
            let start, end; 
            if (settings.cycleType === 'month') { 
                start = new Date(year, month, 1); 
                end = new Date(year, month + 1, 0); 
            } else { 
                const billDay = parseInt(settings.billDay) || 1; 
                if (day > billDay) { 
                    start = new Date(year, month, billDay + 1); 
                    end = new Date(year, month + 1, billDay); 
                } else { 
                    start = new Date(year, month - 1, billDay + 1); 
                    end = new Date(year, month, billDay); 
                } 
            } 
            // Use local date string construction to avoid timezone issues
            const fmt = (d) => d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
            return { start: fmt(start), end: fmt(end) }; 
        }

        window.processRawData = function(data) { 
            const map = new Map(); uniqueBanks = []; 
            data.forEach(row => { 
                const get = (k) => { const f = Object.keys(row).find(x => k.some(y => y.toLowerCase() === x.trim().toLowerCase())); return f ? row[f] : ""; };
                const bank = get(['éŠ€è¡Œ','bank']); const name = get(['å¡å','name']); 
                if(!bank || !name) return;
                const id = `${bank}-${name}`;
                if(!uniqueBanks.includes(bank)) uniqueBanks.push(bank);
                if(!map.has(id)) map.set(id, { 
                    id, bank, name, 
                    color: getBankColor(bank), 
                    offers: [], 
                    defaultMin: 0, 
                    defaultCap: 0, 
                    domesticBase: '', 
                    foreignBase: '',
                    lynnBillDay: 0,
                    andyBillDay: 0,
                    expiryDate: '' 
                });
                const obj = map.get(id);
                
                if (bank === 'å°ä¸­éŠ€') {
                    const g69 = get(['G69']);
                    if (g69) {
                         const n = parseFloat(String(g69).replace(/[^\d.]/g, ''));
                         if (!isNaN(n) && n > 0) obj.defaultMin = n;
                    } else {
                         const min = get(['ä½æ¶ˆ', 'é–€æª»', 'min', 'low', 'å›é¥‹ä½æ¶ˆ']);
                         if(min) { const n = parseFloat(String(min).replace(/[^\d.]/g, '')); if(!isNaN(n) && n > 0) obj.defaultMin = n; }
                    }
                } else {
                    const min = get(['ä½æ¶ˆ', 'é–€æª»', 'min', 'low', 'å›é¥‹ä½æ¶ˆ']);
                    if(min) { const n = parseFloat(String(min).replace(/[^\d.]/g, '')); if(!isNaN(n) && n > 0) obj.defaultMin = n; }
                }

                const capRow = get(['æŒ‡å®šå›é¥‹ä¸Šé™', 'bonus_cap', 'æœ€ä½³åˆ·å¡ä¸Šé™', 'åˆ·å¡ä¸Šé™', 'cap', 'limit', 'ä¸Šé™']);
                if(capRow) { 
                    const n = parseFloat(String(capRow).replace(/[^\d.]/g, '')); 
                    if(!isNaN(n) && n > 0) {
                        obj.defaultCap = Math.max(obj.defaultCap, n);
                    }
                }

                const domBase = get(['åœ‹å…§åŸºç¤å›é¥‹', 'åœ‹å…§åŸºç¤', 'domestic']);
                if(domBase) obj.domesticBase = domBase;

                const forBase = get(['åœ‹å¤–åŸºç¤å›é¥‹', 'åœ‹å¤–åŸºç¤', 'foreign']);
                if(forBase) obj.foreignBase = forBase;

                const baseCap = get(['åŸºç¤å›é¥‹ä¸Šé™', 'base_cap']);
                if (baseCap) obj.baseCap = baseCap;

                const lynnDay = get(['Lynnçµå¸³æ—¥', 'lynn_bill']);
                if (lynnDay) { const n = parseInt(String(lynnDay).replace(/[^\d]/g, '')); if(!isNaN(n)) obj.lynnBillDay = n; }

                const andyDay = get(['Andyçµå¸³æ—¥', 'andy_bill']);
                if (andyDay) { const n = parseInt(String(andyDay).replace(/[^\d]/g, '')); if(!isNaN(n)) obj.andyBillDay = n; }

                const expiry = get(['æ¬Šç›ŠæœŸé™', 'expiry', 'valid_until']);
                if (expiry) obj.expiryDate = expiry;

                const cat = get(['é¡åˆ¥', 'category']);
                if(cat) {
                    let rawRate = String(get(['æœ€ä½³å›é¥‹', 'åŸºç¤+æŒ‡å®šå›é¥‹', 'æœ€é«˜å›é¥‹', 'max_total', 'å›é¥‹', 'rate']) || '0');
                    if(rawRate === '0') rawRate = String(get(['å›é¥‹', 'rate']) || '0'); 

                    let rateVal = 0;
                    if (rawRate.includes('-') || rawRate.includes('~')) {
                         const parts = rawRate.split(/[-~]/).map(p => parseFloat(p.replace('%',''))).filter(n => !isNaN(n));
                         rateVal = Math.max(...parts);
                    } else {
                         rateVal = parseFloat(rawRate.replace('%','')) || 0;
                    }
                    if(!rawRate.includes('%') && rateVal > 0) rawRate += '%';

                    obj.offers.push({ 
                        category: cat, 
                        rate: rateVal, 
                        rateStr: rawRate, 
                        desc: get(['èªªæ˜', 'å‚™è¨»', 'desc', 'note']), 
                        tags: String(get(['é—œéµå­—', 'tags'])).split(/[,ï¼Œã€]/).filter(Boolean), 
                        baseRate: get(['åŸºç¤', 'baseRate']), 
                        cap: get(['ä¸Šé™', 'cap']),
                        paymentMethod: get(['é™å®šæ”¯ä»˜æ–¹å¼', 'é™å®šæ”¯ä»˜', 'payment']),
                        bonusRate: get(['æŒ‡å®šåŠ ç¢¼å›é¥‹', 'bonus_rate']),
                        bonusCap: get(['æŒ‡å®šå›é¥‹ä¸Šé™', 'bonus_cap']),
                        totalRate: get(['åŸºç¤+æŒ‡å®šå›é¥‹', 'åŸºç¤åŠ æŒ‡å®š', 'max_total'])
                    });
                }
            });
            return Array.from(map.values());
        }

        window.getBankColor = function(b) { if(b.includes("å°æ–°")) return "bg-gradient-to-r from-red-400 to-red-500"; if(b.includes("ç‰å±±")) return "bg-gradient-to-r from-emerald-400 to-emerald-500"; if(b.includes("å¯Œé‚¦")) return "bg-gradient-to-r from-cyan-500 to-blue-500"; if(b.includes("åœ‹æ³°") || b.includes("CUBE")) return "bg-gradient-to-r from-lime-500 to-green-500"; return "bg-gradient-to-r from-gray-400 to-gray-500"; }
        
        window.initDropdowns = function() { 
            const b = document.getElementById('bankSelect'); b.innerHTML='<option value="">æ‰€æœ‰éŠ€è¡Œ</option>'; uniqueBanks.forEach(x => { const o = document.createElement('option'); o.value=x; o.text=x; b.appendChild(o); });
            const m = document.getElementById('manageCardFilter'); m.innerHTML='<option value="">ğŸ’³ æ‰€æœ‰ä¿¡ç”¨å¡</option>'; allCardsData.forEach(c => { const o = document.createElement('option'); o.value=c.id; o.text=c.name; m.appendChild(o); });
        }

        window.postToCloud = async function(payload) { 
            if(!API_URL) return { status: 'error', message: 'No API URL' }; 
            try { 
                const response = await fetch(API_URL, { 
                    method: 'POST', body: JSON.stringify(payload) 
                });
                return await response.json();
            } catch(e) { console.error(e); return { status: 'error', message: e.toString() }; } 
        }

        // --- FIXED: ROBUST SYNC LOGIC & TYPE SAFETY ---
        window.syncWithCloud = async function(forceShowLoading = true) { 
            if(!API_URL) return; 
            
            const hasData = transactions.length > 0;
            if (forceShowLoading || !hasData) {
                showLoading(true, "é›²ç«¯åŒæ­¥ä¸­...");
            } else {
                document.getElementById('syncIndicator').classList.remove('hidden');
            }

            try { 
                const r = await fetch(API_URL + '?action=read'); 
                const j = await r.json(); 
                
                if(j.status === 'success' && j.data && Array.isArray(j.data)) { 
                    // Helper to fuzzy match keys (e.g., "Amount", "amount", "money")
                    const getValue = (obj, keys) => {
                        const foundKey = Object.keys(obj).find(k => keys.some(search => k.toLowerCase() === search.toLowerCase()));
                        return foundKey ? obj[foundKey] : null;
                    };

                    const cloudTxs = j.data.map(tx => {
                        let rawAmt = getValue(tx, ['amount', 'money', 'price', 'cost']);
                        let rawDate = getValue(tx, ['date', 'time', 'day']);
                        let rawCat = getValue(tx, ['category', 'type']);
                        let rawItem = getValue(tx, ['item', 'desc', 'name', 'detail']);
                        let rawNote = getValue(tx, ['note', 'memo']);
                        let rawCard = getValue(tx, ['cardId', 'card']);
                        let rawId = getValue(tx, ['id']);
                        let rawTypes = getValue(tx, ['types']);

                        let amt = parseFloat(rawAmt);
                        if(isNaN(amt)) amt = 0;
                        
                        // Sanitize Date
                        let d = String(rawDate || "").trim();
                        d = d.replace(/\//g, '-').split('T')[0]; // 2024/01/01 -> 2024-01-01
                        if(d.length < 8) d = ""; 

                        // Sanitize Types
                        let types = rawTypes;
                        if (typeof types === 'string') {
                             try { types = JSON.parse(types); } catch(e) { types = []; }
                        }
                        if (!Array.isArray(types)) types = [];
                        
                        return { 
                            // FORCE STRING ID
                            id: String(rawId || (Date.now().toString() + Math.random().toString(36).substr(2, 5))),
                            cardId: rawCard || "",
                            amount: amt, 
                            date: d,
                            category: rawCat || "ğŸ“¦ å…¶ä»–",
                            item: rawItem || "",
                            note: rawNote || "",
                            types: types
                        };
                    });

                    // Only overwrite if we found valid data OR if cloud explicitly returned empty array (new user)
                    const validTxs = cloudTxs.filter(tx => tx.date && tx.amount >= 0 && tx.cardId);

                    if (validTxs.length > 0) {
                        transactions = validTxs;
                        localStorage.setItem(getStorageKey('transactions'), JSON.stringify(transactions)); 
                        pruneOldData(); 
                        renderView(); 
                        if(forceShowLoading || !hasData) showToast('åŒæ­¥å®Œæˆ');
                    } else if (j.data.length > 0 && validTxs.length === 0) {
                        console.warn("Sync Warning: Cloud data exists but parsing failed.", j.data[0]);
                    } else {
                        if(forceShowLoading) showToast('é›²ç«¯ç„¡è³‡æ–™');
                    }
                } 
            } catch(e) { 
                console.error("Sync Failed", e);
                if(forceShowLoading) showToast('åŒæ­¥å¤±æ•—: ç¶²è·¯æˆ–æ ¼å¼éŒ¯èª¤'); 
            } finally { 
                showLoading(false); 
                document.getElementById('syncIndicator').classList.add('hidden');
            } 
        }
        
        window.showLoading = function(show, text = "é›²ç«¯åŒæ­¥ä¸­...") { document.getElementById('loadingText').innerText=text; document.getElementById('loadingOverlay').classList.toggle('hidden', !show); }
        window.showToast = function(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.remove('opacity-0', 'pointer-events-none'); setTimeout(() => t.classList.add('opacity-0', 'pointer-events-none'), 2000); }

        window.switchTab = function(view) {
            currentView = view;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const ids = ['headerControls', 'manageControls', 'smallPayControls', 'totalSpendDisplay', 'fabContainer'];
            ids.forEach(id => document.getElementById(id).classList.add('hidden'));
            const aiBot = document.getElementById('btnAiBot');
            const fabContainer = document.getElementById('fabContainer');

            if(view === 'search') { 
                document.getElementById('btnSearch').classList.add('active'); 
                document.getElementById('headerControls').classList.remove('hidden');
                aiBot.classList.remove('hidden'); setTimeout(()=> aiBot.classList.add('show'), 50);
            } else {
                aiBot.classList.remove('show'); setTimeout(()=> aiBot.classList.add('hidden'), 300);
            }

            if (view === 'manage') { 
                document.getElementById('btnManage').classList.add('active');
                document.getElementById('manageControls').classList.remove('hidden');
                document.getElementById('totalSpendDisplay').classList.remove('hidden');
                fabContainer.classList.remove('hidden'); fabContainer.style.display='block';
            } else if (view === 'smallpay') {
                document.getElementById('btnSmallPay').classList.add('active');
                document.getElementById('smallPayControls').classList.remove('hidden');
                fabContainer.classList.add('hidden'); fabContainer.style.display='none';
            }
            renderView();
        }

        window.renderView = function() {
            const container = document.getElementById('mainContent');
            container.innerHTML = "";
            if (currentView === 'search') renderSearchView(container);
            else if (currentView === 'manage') renderManageView(container);
            lucide.createIcons();
            checkScroll();
        }

        window.renderSearchView = function(container) {
            const searchText = document.getElementById('searchInput').value.toLowerCase().trim();
            const filtered = allCardsData.filter(c => (!currentBankFilter || c.bank === currentBankFilter) && (!currentCardFilter || c.name === currentCardFilter)).map(card => {
                const matches = card.offers.filter(offer => {
                    if (offer.rate <= 0) return false;
                    if (!searchText) return true;
                    return offer.desc.toLowerCase().includes(searchText) || offer.category.toLowerCase().includes(searchText) || card.name.toLowerCase().includes(searchText) || offer.tags.some(t => t.toLowerCase().includes(searchText));
                });
                matches.sort((a,b) => b.rate - a.rate);
                const maxRate = matches.length > 0 ? matches[0].rate : 0;
                return { ...card, matches, maxRate, hasMatch: matches.length > 0 };
            }).filter(c => c.hasMatch).sort((a,b) => b.maxRate - a.maxRate);

            if(filtered.length === 0) { document.getElementById('noResult').classList.remove('hidden'); return; }
            else document.getElementById('noResult').classList.add('hidden');

            filtered.forEach(card => {
                const el = document.createElement('div');
                el.className = "glass-card rounded-3xl p-5 mb-4 fade-in relative";
                let baseRewardHtml = '';
                let bases = [];
                if(card.domesticBase) bases.push(`ğŸ‡¹ğŸ‡¼ å°ç£ ${card.domesticBase}`);
                if(card.foreignBase) bases.push(`âœˆï¸ åœ‹å¤– ${card.foreignBase}`);
                if(card.baseCap) bases.push(`ğŸ›‘ åŸºç¤ä¸Šé™: ${card.baseCap}`);
                if(bases.length > 0) {
                    baseRewardHtml = `<div class="flex flex-wrap gap-2 mb-3 text-[10px] text-slate-500 font-bold bg-slate-50/50 p-2 rounded-xl border border-slate-100/50">` + bases.map(b => `<span>${b}</span>`).join('<span class="opacity-30">|</span>') + `</div>`;
                }
                el.innerHTML = `<div class="flex gap-3 items-center mb-2 pb-2 border-b border-gray-100/50"><span class="bank-badge ${card.color}">${card.bank}</span><h3 class="font-bold text-slate-700 serif-font text-lg">${card.name}</h3></div>${baseRewardHtml}`;
                card.matches.forEach(offer => {
                    let displayTags = offer.tags;
                    if (searchText) { const matchingTags = offer.tags.filter(t => t.toLowerCase().includes(searchText)); if (matchingTags.length > 0) displayTags = matchingTags; }
                    const TAG_LIMIT = 5;
                    const hasMore = displayTags.length > TAG_LIMIT;
                    const shownTags = displayTags.slice(0, TAG_LIMIT);
                    const hiddenTags = displayTags.slice(TAG_LIMIT);
                    const tagClassId = `extra-tag-${card.id}-${offer.category.replace(/\s/g,'')}`;
                    let tagsHtml = shownTags.map(tag => {
                        const isHit = searchText && tag.toLowerCase().includes(searchText);
                        const style = isHit ? 'bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-md' : 'bg-slate-200/70 text-slate-700';
                        return `<span class="text-[10px] px-2.5 py-1 rounded-full font-medium ${style} transition-colors">${tag}</span>`;
                    }).join('');
                    if(hasMore) {
                        const hiddenHtml = hiddenTags.map(tag => `<span class="text-[10px] px-2.5 py-1 rounded-full font-medium bg-slate-200/70 text-slate-700 hidden ${tagClassId}">${tag}</span>`).join('');
                        tagsHtml += hiddenHtml;
                        tagsHtml += `<button onclick="toggleTags(this, '${tagClassId}', ${hiddenTags.length})" class="text-[10px] px-2.5 py-1 rounded-full font-bold bg-indigo-100 text-indigo-500 hover:bg-indigo-200 transition-colors">+${hiddenTags.length}</button>`;
                    }
                    let infoBadges = '';
                    if(offer.paymentMethod) infoBadges += `<span class="text-[9px] bg-blue-50 text-blue-500 border border-blue-100 px-1.5 py-0.5 rounded-2xl font-bold ml-1">é™ ${offer.paymentMethod}</span>`;
                    if(offer.totalRate) infoBadges += `<span class="text-[9px] bg-pink-50 text-pink-500 border border-pink-100 px-1.5 py-0.5 rounded-2xl font-bold ml-1">ğŸ”¥ æœ€é«˜ ${offer.totalRate}</span>`;
                    if(card.defaultMin > 0) infoBadges += `<span class="text-[9px] bg-orange-50 text-orange-500 border border-orange-100 px-1.5 py-0.5 rounded-2xl font-bold ml-1">ğŸ’° ä½æ¶ˆ: $${card.defaultMin.toLocaleString()}</span>`;
                    if(offer.bonusCap) infoBadges += `<span class="text-[9px] bg-pink-50 text-pink-500 border border-pink-100 px-1.5 py-0.5 rounded-2xl font-bold ml-1">ğŸ›‘ ä¸Šé™: ${offer.bonusCap}</span>`;
                    let extraDetails = '';
                    if(offer.bonusRate) extraDetails += `<span class="text-[10px] text-indigo-400 font-bold mr-2">ğŸ åŠ ç¢¼: ${offer.bonusRate}</span>`;
                    if(extraDetails) extraDetails = `<div class="mb-1.5 flex flex-wrap">${extraDetails}</div>`;
                    el.innerHTML += `<div class="mb-4 last:mb-0 p-3 bg-white/40 rounded-2xl border border-white/50 shadow-sm"><div class="flex justify-between items-center mb-1"><h4 class="font-bold text-slate-700 text-sm flex items-center gap-1.5 flex-wrap">â˜… ${offer.category} ${infoBadges}</h4><span class="text-xl font-bold text-indigo-500 serif-font">${offer.rateStr}</span></div>${extraDetails}<p class="text-xs text-slate-500 mb-2 leading-relaxed">${offer.desc}</p><div class="flex flex-wrap gap-1.5">${tagsHtml}</div></div>`;
                });
                if (card.expiryDate) { el.innerHTML += `<div class="mt-2 pt-2 border-t border-slate-100 text-[10px] text-right text-slate-400 font-medium">ğŸ“… æœŸé™: ${card.expiryDate}</div>`; }
                container.appendChild(el);
            });
        }
        
        window.renderManageView = function(container) {
            const cardStats = allCardsData.map(card => {
                const settings = cardSettings[card.id] || {};
                const cycleType = settings.cycleType || 'month';
                let defaultBillDay = 1;
                if(currentUser === 'Lynn' && card.lynnBillDay) defaultBillDay = card.lynnBillDay;
                if(currentUser === 'Andy' && card.andyBillDay) defaultBillDay = card.andyBillDay;
                const billDay = settings.billDay || defaultBillDay;
                const { start, end } = getCycleRange({ cycleType, billDay }, new Date());
                const cardTxs = transactions.filter(t => t.cardId === card.id && t.date >= start && t.date <= end);
                
                // Sort Txs by date desc
                cardTxs.sort((a,b) => new Date(b.date) - new Date(a.date));
                
                // Calculate totals based on types
                let totalSpent = 0;
                let totalCap = 0; // For Reward Cap Bar
                let totalMin = 0; // For Min Spend Bar

                cardTxs.forEach(tx => {
                    const amt = Number(tx.amount);
                    totalSpent += amt; 
                    const types = tx.types || [];
                    if (types.includes('reward')) { totalCap += amt; }
                    if (types.includes('general')) { totalMin += amt; }
                });

                const cap = settings.cap || card.defaultCap || 0;
                const min = settings.min || card.defaultMin || 0;
                return { ...card, total: totalSpent, totalCap, totalMin, cap, min, start, end, settings, billDay, cardTxs };
            });

            // Sort: Active cards (total > 0) first, then by user order
            cardStats.sort((a, b) => {
                const aActive = a.total > 0 ? 1 : 0;
                const bActive = b.total > 0 ? 1 : 0;
                if (aActive !== bActive) return bActive - aActive;
                let idxA = cardSortOrder.indexOf(a.id);
                let idxB = cardSortOrder.indexOf(b.id);
                if(idxA === -1) idxA = 9999;
                if(idxB === -1) idxB = 9999;
                return idxA - idxB;
            });

            let totalAll = 0;
            const toggleActive = document.getElementById('toggleActiveSwitch');
            if (showActiveOnly) toggleActive.classList.add('toggle-checked'); else toggleActive.classList.remove('toggle-checked');

            cardStats.forEach(card => {
                if (manageCardFilter && card.id !== manageCardFilter) return;
                if (showActiveOnly && card.total === 0) return;
                totalAll += card.total;

                const el = document.createElement('div');
                el.className = "bg-white rounded-2xl p-5 mb-4 shadow-sm border border-slate-100 fade-in";
                
                let nameHtml = card.name;
                if (card.min > 0) nameHtml += ' <span title="æœ‰ä½æ¶ˆ">ğŸ’°</span>';

                let barsHtml = '';
                if (card.cap > 0) {
                    const capPct = Math.min((card.totalCap / card.cap) * 100, 100);
                    const capColor = capPct >= 90 ? 'bg-red-500' : 'bg-indigo-500';
                    const capText = `${card.totalCap.toLocaleString()} / ${card.cap.toLocaleString()}`;
                    barsHtml += `<div class="mb-3"><div class="flex justify-between text-[10px] font-bold text-slate-400 mb-1"><span>å›é¥‹ä¸Šé™ (${Math.round(capPct)}%)</span><span class="${capPct >= 90 ? 'text-red-500' : ''}">${capText}</span></div><div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden"><div class="h-full ${capColor} transition-all duration-500" style="width:${capPct}%"></div></div></div>`;
                }

                if (card.min > 0) {
                    const minPct = Math.min((card.totalMin / card.min) * 100, 100);
                    const minColor = minPct >= 100 ? 'bg-emerald-500' : 'bg-orange-400';
                    const minText = minPct >= 100 ? 'âœ… å·²é”æ¨™' : `å°šå·® $${(card.min - card.totalMin).toLocaleString()}`;
                    barsHtml += `<div class="mb-2"><div class="flex justify-between text-[10px] font-bold text-slate-400 mb-1"><span>ä½æ¶ˆé–€æª» (${Math.round(minPct)}%)</span><span class="${minPct >= 100 ? 'text-emerald-500' : 'text-orange-400'}">${minText}</span></div><div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden"><div class="h-full ${minColor} transition-all duration-500" style="width:${minPct}%"></div></div></div>`;
                }
                
                let txListHtml = '';
                if(card.cardTxs.length > 0) {
                    txListHtml = `<div class="mt-4 pt-3 border-t border-slate-50 space-y-2">`;
                    card.cardTxs.forEach(tx => {
                        txListHtml += `
                            <div class="flex justify-between items-center text-xs group">
                                <div class="flex items-center gap-2 overflow-hidden">
                                    <span class="text-slate-400 font-mono flex-shrink-0">${tx.date.slice(5)}</span>
                                    <span class="text-slate-700 truncate font-bold">${tx.item || tx.category}</span>
                                </div>
                                <div class="flex items-center gap-2 flex-shrink-0">
                                    <span class="font-bold text-slate-600">$${Number(tx.amount).toLocaleString()}</span>
                                    <button onclick="openTransactionModal('${tx.id}')" class="text-slate-300 hover:text-indigo-500 p-1"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                                </div>
                            </div>
                        `;
                    });
                    txListHtml += `</div>`;
                }

                el.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <span class="bank-badge ${card.color}">${card.bank}</span>
                            <div><h3 class="font-bold text-slate-700 text-sm">${nameHtml}</h3><p class="text-[10px] text-slate-400 mt-0.5">çµå¸³æ—¥: æ¯æœˆ ${card.billDay} è™Ÿ</p></div>
                        </div>
                        <div class="text-right"><div class="text-xl font-bold text-slate-800">$${card.total.toLocaleString()}</div><div class="text-[10px] text-slate-400">æœ¬æœŸç´¯ç©</div></div>
                    </div>
                    ${barsHtml}
                    ${txListHtml}
                    <div class="grid grid-cols-2 gap-2 mt-3 pt-3 border-t border-slate-50">
                        <button onclick="openTransactionModal(); document.getElementById('txCardSelect').value='${card.id}';" class="py-2 rounded-xl bg-indigo-50 text-indigo-600 text-xs font-bold hover:bg-indigo-100 transition-colors">è¨˜ä¸€ç­†</button>
                        <div class="flex gap-2"><button onclick="openSettingsModal('${card.id}')" class="flex-1 py-2 rounded-xl bg-slate-50 text-slate-500 text-xs font-bold hover:bg-slate-100 transition-colors">è¨­å®š</button></div>
                    </div>
                `;
                container.appendChild(el);
            });
            document.getElementById('totalSpendDisplay').innerText = `æœ¬æœŸ $${totalAll.toLocaleString()}`;
        }
        
        window.toggleActiveOnly = function() { showActiveOnly = !showActiveOnly; renderView(); }
        window.toggleTags = function(btn, classId, count) {
            const els = document.querySelectorAll('.' + classId);
            const isHidden = els[0].classList.contains('hidden');
            els.forEach(el => el.classList.toggle('hidden'));
            if(isHidden) {
                btn.innerText = "æ”¶èµ·";
                btn.classList.add('bg-slate-200', 'text-slate-500');
                btn.classList.remove('bg-indigo-100', 'text-indigo-500');
            } else {
                btn.innerText = "+" + count;
                btn.classList.remove('bg-slate-200', 'text-slate-500');
                btn.classList.add('bg-indigo-100', 'text-indigo-500');
            }
        }

        window.openCardSortModal = function() {
            const modal = document.getElementById('cardSortModal');
            if(!modal) return;
            
            // Init sort order if empty
            if (cardSortOrder.length === 0) { cardSortOrder = allCardsData.map(c => c.id); }
            // Add new cards to sort order
            const existingIds = new Set(cardSortOrder);
            allCardsData.forEach(c => { if(!existingIds.has(c.id)) cardSortOrder.push(c.id); });
            
            renderCardSortList();
            modal.classList.remove('hidden');

            // Init SortableJS
            const el = document.getElementById('cardSortList');
            if(sortableInstance) sortableInstance.destroy();
            
            sortableInstance = new Sortable(el, {
                animation: 150,
                handle: '.drag-handle', // <--- Add this
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: function (evt) {
                    // Reorder array based on DOM
                    const newOrder = [];
                    const items = el.querySelectorAll('[data-id]');
                    items.forEach(item => newOrder.push(item.getAttribute('data-id')));
                    cardSortOrder = newOrder;
                    localStorage.setItem(getStorageKey('card_order'), JSON.stringify(cardSortOrder));
                }
            });
        }
        
        window.renderCardSortList = function() {
             const listContainer = document.getElementById('cardSortList');
             listContainer.innerHTML = '';
             const validOrder = cardSortOrder.filter(id => allCardsData.find(c => c.id === id));
             if(validOrder.length !== cardSortOrder.length) { cardSortOrder = validOrder; }
             
             validOrder.forEach((cardId, index) => {
                 const card = allCardsData.find(c => c.id === cardId);
                 if(!card) return;
                 const row = document.createElement('div');
                 row.className = "flex justify-between items-center p-3 bg-white border border-slate-100 rounded-xl mb-2 shadow-sm";
                 row.setAttribute('data-id', card.id);
                 row.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden flex-1">
                        <div class="truncate"><span class="bank-badge ${card.color} scale-75 origin-left inline-block -mr-1">${card.bank}</span><span class="text-sm font-bold text-slate-700">${card.name}</span></div>
                    </div>
                    <!-- Right Grip Handle -->
                    <div class="drag-handle p-3 text-slate-400 cursor-grab active:cursor-grabbing touch-none">
                        <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                    </div>
                 `;
                 listContainer.appendChild(row);
             });
             lucide.createIcons();
        }

        // --- FIXED: OPEN TRANSACTION MODAL WITH TYPE SAFETY ---
        window.openTransactionModal = function(existingTxId) {
            const modal = document.getElementById('transactionModal');
            if(!modal) return; 

            const select = document.getElementById('txCardSelect');
            const btnDel = document.getElementById('btnDeleteTx');
            const title = document.getElementById('txModalTitle');
            
            select.innerHTML = '';
            const defaultOpt = document.createElement('option');
            defaultOpt.value = "";
            defaultOpt.text = "è«‹é¸æ“‡å¡ç‰‡";
            defaultOpt.disabled = true;
            defaultOpt.selected = true;
            select.appendChild(defaultOpt);
            
            let sortedCards = [...allCardsData];
            if (cardSortOrder.length > 0) {
                sortedCards.sort((a, b) => {
                    let idxA = cardSortOrder.indexOf(a.id);
                    let idxB = cardSortOrder.indexOf(b.id);
                    if (idxA === -1) idxA = 9999;
                    if (idxB === -1) idxB = 9999;
                    return idxA - idxB;
                });
            }
            sortedCards.forEach(c => { const opt = document.createElement('option'); opt.value = c.id; opt.text = `${c.bank} - ${c.name}`; select.appendChild(opt); });

            if (existingTxId) {
                editingTransactionId = existingTxId;
                if(title) title.innerText = "ä¿®æ”¹æ¶ˆè²»ç´€éŒ„";
                // FIXED: Use String comparison for ID
                const tx = transactions.find(t => String(t.id) === String(existingTxId));
                if (tx) {
                    select.value = tx.cardId;
                    document.getElementById('txAmount').value = tx.amount;
                    document.getElementById('txDate').value = tx.date;
                    document.getElementById('txCategory').value = tx.category || "ğŸ½ï¸ é¤é£²";
                    document.getElementById('txItem').value = tx.item || "";
                    document.getElementById('txNote').value = tx.note || "";
                    const isReward = tx.types ? tx.types.includes('reward') : true;
                    const isGeneral = tx.types ? tx.types.includes('general') : false;
                    document.getElementById('checkReward').checked = isReward;
                    document.getElementById('checkGeneral').checked = isGeneral;
                }
                if(btnDel) { btnDel.classList.remove('hidden'); btnDel.style.display = 'block'; }
            } else {
                editingTransactionId = null;
                if(title) title.innerText = "è¨˜ä¸€ç­†æ¶ˆè²»";
                document.getElementById('txAmount').value = '';
                document.getElementById('txDate').valueAsDate = new Date();
                document.getElementById('txCategory').value = "ğŸ½ï¸ é¤é£²";
                document.getElementById('txItem').value = '';
                document.getElementById('txNote').value = '';
                document.getElementById('checkReward').checked = true;
                document.getElementById('checkGeneral').checked = false;
                if(currentView === 'manage' && manageCardFilter) { select.value = manageCardFilter; } else { select.value = ""; }
                if(btnDel) { btnDel.classList.add('hidden'); btnDel.style.display = 'none'; }
            }
            modal.classList.remove('hidden');
        }

        window.closeTransactionModal = function() { document.getElementById('transactionModal').classList.add('hidden'); }
        window.openDeleteConfirm = function() { document.getElementById('deleteConfirmModal').classList.remove('hidden'); }
        
        // --- FIXED: SAVE TRANSACTION WITH TYPE SAFETY ---
        window.saveTransaction = async function() {
            if (!currentUser) return alert('è«‹å…ˆé¸æ“‡ä½¿ç”¨è€…èº«åˆ† (è¨­å®š > é¸æ“‡èº«åˆ†)');
            const cardId = document.getElementById('txCardSelect').value;
            const amount = parseFloat(document.getElementById('txAmount').value);
            const date = document.getElementById('txDate').value;
            const category = document.getElementById('txCategory').value;
            const item = document.getElementById('txItem').value; 
            const note = document.getElementById('txNote').value;
            const types = [];
            if(document.getElementById('checkReward').checked) types.push('reward');
            if(document.getElementById('checkGeneral').checked) types.push('general');

            if (!cardId || isNaN(amount) || amount <= 0 || !date) { alert(`è«‹è¨˜å¾—å¡«å¯«å¿…è¦æ¬„ä½å–”`); return; }
            
            // FIXED: Ensure timestamp/id logic is robust
            let txData = { cardId, amount, date, category, item, note, types, timestamp: Date.now() };
            let action = 'add'; 

            if (editingTransactionId) {
                action = 'edit';
                // FIXED: Use String comparison
                const index = transactions.findIndex(t => String(t.id) === String(editingTransactionId));
                if (index !== -1) { 
                    txData.id = editingTransactionId; 
                    transactions[index] = txData; 
                }
            } else {
                action = 'add';
                // FIXED: Robust ID generation (String)
                txData.id = Date.now().toString() + Math.random().toString(36).substr(2, 5);
                transactions.push(txData);
            }

            localStorage.setItem(getStorageKey('transactions'), JSON.stringify(transactions));
            renderView();
            closeTransactionModal();
            showToast('ğŸ”„ é›²ç«¯å„²å­˜ä¸­...', 2000);
            
            try {
                const result = await postToCloud({ action: action, item: txData, id: txData.id });
                if (result.status === 'success') {
                    showToast('âœ… é›²ç«¯å·²åŒæ­¥');
                } else {
                    showToast('âŒ é›²ç«¯åŒæ­¥å¤±æ•—');
                }
            } catch(e) {
                showToast('âŒ ç¶²è·¯éŒ¯èª¤');
            }
        }

        // --- FIXED: DELETE TRANSACTION WITH TYPE SAFETY ---
        window.executeDelete = async function() {
            if (!currentUser) return;
            document.getElementById('deleteConfirmModal').classList.add('hidden'); 
            
            const txId = editingTransactionId;
            // FIXED: Use String comparison for filtering
            transactions = transactions.filter(t => String(t.id) !== String(txId));
            localStorage.setItem(getStorageKey('transactions'), JSON.stringify(transactions));
            
            renderView();
            closeTransactionModal();
            if(!document.getElementById('historyModal').classList.contains('hidden')) window.openHistoryModal();
            showToast('ğŸ—‘ï¸ å·²åˆªé™¤ (åŒæ­¥ä¸­...)');

            try {
                const result = await postToCloud({ action: 'delete', id: txId }); 
                if (result.status === 'success') {
                    // Silent success
                } else {
                    alert('åˆªé™¤å¤±æ•—ï¼šé›²ç«¯è³‡æ–™åº«æœªå›æ‡‰ã€‚');
                }
            } catch(e) {
                alert('åˆªé™¤å¤±æ•—ï¼šç¶²è·¯éŒ¯èª¤ã€‚');
            }
        }
        
        // --- HISTORY FUNCTIONS ---
        // V101: Updated History Function
        window.openHistoryModal = function() {
            document.getElementById('historyModal').classList.remove('hidden');
            
            const monthSelect = document.getElementById('historyMonthSelect');
            monthSelect.innerHTML = '';
            
            const months = new Set();
            transactions.forEach(tx => {
                if(tx.date && typeof tx.date === 'string' && tx.date.length >= 7) {
                    months.add(tx.date.substring(0, 7)); // YYYY-MM
                }
            });
            
            const sortedMonths = Array.from(months).sort().reverse();
            if(sortedMonths.length === 0) {
                const now = new Date();
                const m = now.toISOString().substring(0, 7);
                sortedMonths.push(m);
            }

            sortedMonths.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.text = m;
                monthSelect.appendChild(opt);
            });
            
            if(sortedMonths.length > 0) monthSelect.value = sortedMonths[0];
            
            renderHistoryMonth();
        }

        window.renderHistoryMonth = function() {
            const selectedMonth = document.getElementById('historyMonthSelect').value;
            const container = document.getElementById('historyMonthList');
            container.innerHTML = '';
            
            let monthTxs = transactions.filter(tx => tx.date && tx.date.startsWith(selectedMonth));
            if(manageCardFilter) monthTxs = monthTxs.filter(t => t.cardId === manageCardFilter);
            
            monthTxs.sort((a,b) => new Date(b.date) - new Date(a.date));
            
            const total = monthTxs.reduce((acc, t) => acc + Number(t.amount), 0);
            document.getElementById('historyMonthTotal').innerText = `$${total.toLocaleString()}`;

            if(monthTxs.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-slate-400 text-sm">æœ¬æœˆç„¡æ¶ˆè²»ç´€éŒ„</div>';
            } else {
                monthTxs.forEach(tx => {
                    const card = allCardsData.find(c => c.id === tx.cardId) || { name: 'æœªçŸ¥å¡ç‰‡', bank: 'æœªçŸ¥' };
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center p-3 bg-slate-50 border border-slate-100 rounded-xl tx-row";
                    div.onclick = () => openTransactionModal(tx.id);
                    
                    const catStr = tx.category || "ğŸ“¦ å…¶ä»–";
                    const icon = catStr.split(' ')[0] || "ğŸ“¦";

                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center text-sm shadow-sm">${icon}</div>
                            <div>
                                <div class="flex items-center gap-2"><h4 class="font-bold text-slate-700 text-xs">${tx.item || tx.category || "å…¶ä»–"}</h4><span class="text-[9px] text-slate-400 bg-white px-1 rounded border border-slate-100">${card.name}</span></div>
                                <p class="text-[9px] text-slate-400 mt-0.5">${tx.date} ${tx.note ? 'Â· '+tx.note : ''}</p>
                            </div>
                        </div>
                        <span class="font-bold text-slate-700 text-sm">$${Number(tx.amount).toLocaleString()}</span>
                    `;
                    container.appendChild(div);
                });
            }
            renderPieChart(monthTxs);
        }

        window.renderPieChart = function(txs) {
            const ctx = document.getElementById('historyPieChart').getContext('2d');
            
            const catTotals = {};
            txs.forEach(tx => {
                const catStr = tx.category || "ğŸ“¦ å…¶ä»–";
                const cat = catStr.includes(' ') ? catStr.split(' ')[1] : catStr; 
                catTotals[cat] = (catTotals[cat] || 0) + Number(tx.amount);
            });

            const labels = Object.keys(catTotals);
            const data = Object.values(catTotals);
            
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', 
                '#C9CBCF', '#E7E9ED', '#71B37C', '#EC932F', '#52B3D9'
            ];

            if (historyChartInstance) {
                historyChartInstance.destroy();
            }

            if (data.length === 0) {
                return;
            }

            historyChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } },
                        tooltip: { 
                            callbacks: { 
                                label: function(context) { 
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    label += '$' + context.parsed.toLocaleString();
                                    return label;
                                } 
                            } 
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        window.closeHistoryModal = function() { document.getElementById('historyModal').classList.add('hidden'); }

        // --- SETTINGS FUNCTIONS ---
        window.openSettingsModal = function(cardId) {
            editingCardId = cardId;
            const card = allCardsData.find(c => c.id === cardId);
            const settings = cardSettings[cardId] || {};
            
            document.getElementById('settingsCardName').innerText = `${card.bank} ${card.name}`;
            document.getElementById('settingCap').value = settings.cap || card.defaultCap || '';
            document.getElementById('settingMin').value = settings.min || card.defaultMin || '';
            document.getElementById('settingsModal').classList.remove('hidden');
            setCycleMode(settings.cycleType || 'month');
            
            let defaultBillDay = 1;
            if(currentUser === 'Lynn' && card.lynnBillDay) defaultBillDay = card.lynnBillDay;
            if(currentUser === 'Andy' && card.andyBillDay) defaultBillDay = card.andyBillDay;
            document.getElementById('settingBillDay').value = settings.billDay || defaultBillDay;
        }

        window.setCycleMode = function(mode) {
            const btnMonth = document.getElementById('btnCycleMonth');
            const btnBill = document.getElementById('btnCycleBill');
            const group = document.getElementById('billDateInputGroup');
            
            if(mode === 'month') {
                btnMonth.classList.add('bg-indigo-500', 'text-white', 'border-transparent');
                btnMonth.classList.remove('bg-white', 'text-slate-500');
                btnBill.classList.remove('bg-indigo-500', 'text-white', 'border-transparent');
                group.classList.add('hidden');
            } else {
                btnBill.classList.add('bg-indigo-500', 'text-white', 'border-transparent');
                btnBill.classList.remove('bg-white', 'text-slate-500');
                btnMonth.classList.remove('bg-indigo-500', 'text-white', 'border-transparent');
                group.classList.remove('hidden'); group.classList.add('flex');
            }
            document.getElementById('settingsModal').dataset.mode = mode;
        }

        window.saveCardSettings = function() {
            if(!editingCardId) return;
            const cycleType = document.getElementById('settingsModal').dataset.mode;
            const billDay = parseInt(document.getElementById('settingBillDay').value);
            const cap = parseFloat(document.getElementById('settingCap').value);
            const min = parseFloat(document.getElementById('settingMin').value);
            
            cardSettings[editingCardId] = { cycleType, billDay, cap, min };
            localStorage.setItem(getStorageKey('card_settings'), JSON.stringify(cardSettings));
            closeSettingsModal();
            renderView();
            showToast('è¨­å®šå·²å„²å­˜');
        }
        window.closeSettingsModal = function() { document.getElementById('settingsModal').classList.add('hidden'); }

        // --- SMALL PAY FUNCTIONS ---
        // V94 Update: New Table Rendering Logic
        window.filterSmallPayByCity = function() {
             const city = document.getElementById('smallPayCitySelect').value;
             document.getElementById('smallPayInput').value = ''; 
             document.getElementById('smallPaySuggestions').classList.add('hidden');

             if(!city) {
                 document.getElementById('smallPayResult').classList.add('hidden');
                 return;
             }
             
             currentSmallPayResults = SMALL_PAYMENT_STORES_DB.filter(s => s.city.includes(city) || s.city === 'å…¨å°');
             currentSmallPayPage = 1;
             
             renderSmallPayTable();
        }

        window.renderSmallPayTable = function() {
            const resDiv = document.getElementById('smallPayResult');
            
            if (currentSmallPayResults.length === 0) {
                resDiv.innerHTML = `<div class="p-4 text-center text-slate-400 text-sm">è©²ç¸£å¸‚å°šç„¡è³‡æ–™</div>`;
                resDiv.classList.remove('hidden');
                return;
            }

            const totalPages = Math.ceil(currentSmallPayResults.length / SMALL_PAY_ITEMS_PER_PAGE);
            const start = (currentSmallPayPage - 1) * SMALL_PAY_ITEMS_PER_PAGE;
            const end = start + SMALL_PAY_ITEMS_PER_PAGE;
            const pageData = currentSmallPayResults.slice(start, end);

            let html = `
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden fade-in">
                    <div class="p-3 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center">
                        <span class="text-xs font-bold text-indigo-600">æœå°‹çµæœ: ${currentSmallPayResults.length} ç­†</span>
                        <span class="text-[10px] text-slate-400">ç¬¬ ${currentSmallPayPage} / ${totalPages} é </span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-100">
                                <tr>
                                    <th class="px-3 py-2 whitespace-nowrap">åº—å®¶åç¨±</th>
                                    <th class="px-3 py-2 whitespace-nowrap">å€åŸŸ</th>
                                    <th class="px-3 py-2 whitespace-nowrap">å‚™è¨»</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
            `;

            pageData.forEach(item => {
                html += `
                    <tr class="hover:bg-slate-50/50">
                        <td class="px-3 py-2 font-bold text-slate-700">${item.name}</td>
                        <td class="px-3 py-2 text-slate-500">${item.city}</td>
                        <td class="px-3 py-2 text-slate-400 truncate max-w-[100px]">${item.address || '-'}</td>
                    </tr>
                `;
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                    <div class="p-3 border-t border-slate-100 flex justify-between items-center gap-2">
                        <button onclick="changeSmallPayPage(-1)" ${currentSmallPayPage === 1 ? 'disabled' : ''} class="px-3 py-1.5 rounded-lg bg-slate-100 text-slate-500 text-xs font-bold disabled:opacity-30 hover:bg-slate-200">ä¸Šä¸€é </button>
                        <span class="text-xs font-bold text-slate-400">${currentSmallPayPage}</span>
                        <button onclick="changeSmallPayPage(1)" ${currentSmallPayPage === totalPages ? 'disabled' : ''} class="px-3 py-1.5 rounded-lg bg-indigo-50 text-indigo-600 text-xs font-bold disabled:opacity-30 hover:bg-indigo-100">ä¸‹ä¸€é </button>
                    </div>
                </div>
            `;

            resDiv.innerHTML = html;
            resDiv.classList.remove('hidden');
        }

        window.changeSmallPayPage = function(delta) {
            const totalPages = Math.ceil(currentSmallPayResults.length / SMALL_PAY_ITEMS_PER_PAGE);
            const newPage = currentSmallPayPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                currentSmallPayPage = newPage;
                renderSmallPayTable();
            }
        }

        // Keep existing single store check logic for search input
        window.onSmallPayInput = function(val) {
             const list = document.getElementById('smallPaySuggestions');
             if(!val) { list.classList.add('hidden'); return; }
             const matches = SMALL_PAYMENT_STORES_DB.filter(s => s.name.includes(val));
             list.innerHTML = '';
             if(matches.length > 0) {
                 matches.slice(0, 10).forEach(m => {
                     const div = document.createElement('div');
                     div.className = 'suggestion-item';
                     div.innerHTML = `<span>${m.name}</span><span class="text-xs text-slate-300">${m.city}</span>`;
                     div.onclick = () => {
                         document.getElementById('smallPayInput').value = m.name;
                         list.classList.add('hidden');
                         checkSmallPay(m.name);
                     };
                     list.appendChild(div);
                 });
                 list.classList.remove('hidden');
             } else { list.classList.add('hidden'); }
        }

        window.clearSmallPaySearch = function() {
            document.getElementById('smallPayInput').value = '';
            document.getElementById('smallPaySuggestions').classList.add('hidden');
            document.getElementById('smallPayResult').classList.add('hidden');
        }
        
        function checkSmallPay(name) {
             const res = document.getElementById('smallPayResult');
             res.classList.remove('hidden');
             // Simple check logic: if in DB => Warning
             const found = SMALL_PAYMENT_STORES_DB.some(s => s.name.includes(name));
             if(found) {
                 res.innerHTML = `
                    <div class="bg-red-50 border border-red-100 rounded-2xl p-5 text-center shadow-sm">
                        <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl">âš ï¸</div>
                        <h3 class="text-red-600 font-bold text-lg mb-1">æ³¨æ„ï¼é€™å¯èƒ½æ˜¯å°é¡æ”¯ä»˜</h3>
                        <p class="text-xs text-red-400 leading-relaxed">åœ¨ ${name} åˆ·å¡å¯èƒ½è¢«æ­¸é¡ç‚ºå°é¡æ”¯ä»˜ï¼Œä¸€èˆ¬ä¿¡ç”¨å¡å¯èƒ½<b>æ²’æœ‰å›é¥‹</b>ã€‚</p>
                    </div>`;
             } else {
                 res.innerHTML = `
                    <div class="bg-emerald-50 border border-emerald-100 rounded-2xl p-5 text-center shadow-sm">
                        <div class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl">âœ…</div>
                        <h3 class="text-emerald-600 font-bold text-lg mb-1">Passï¼éå°é¡æ”¯ä»˜é»‘åå–®</h3>
                        <p class="text-xs text-emerald-500 leading-relaxed">è³‡æ–™åº«ä¸­æœªæ‰¾åˆ° ${name} çš„å°é¡æ”¯ä»˜ç´€éŒ„ï¼Œæ‡‰å¯æ­£å¸¸å›é¥‹ã€‚</p>
                    </div>`;
             }
        }

        window.saveSmallPayDb = function() {
            const url = document.getElementById('smallPayCsvUrl').value;
            if(url) {
                loadSmallPayCsv(url);
                document.getElementById('smallPayDbModal').classList.add('hidden');
                showToast('è³‡æ–™åº«å·²æ›´æ–°');
            }
        }

        // --- AI CHAT ---
        window.openAiChat = function() { document.getElementById('aiChatModal').classList.remove('hidden'); }
        window.sendAiMessage = function() {
            const input = document.getElementById('aiInput');
            const txt = input.value.trim();
            if(!txt) return;
            const content = document.getElementById('aiChatContent');
            
            // User Msg
            const u = document.createElement('div'); u.className = "flex gap-3 flex-row-reverse animate-in slide-in-from-right-5";
            u.innerHTML = `<div class="bg-indigo-500 text-white p-3 rounded-2xl rounded-tr-none shadow-md text-sm max-w-[80%]">${txt}</div>`;
            content.appendChild(u);
            input.value = '';
            content.scrollTop = content.scrollHeight;

            // AI Reply Logic (Simple Mock)
            setTimeout(() => {
                let matches = [];
                // Find cards matching keyword
                allCardsData.forEach(c => {
                    const hit = c.offers.find(o => o.desc.includes(txt) || o.category.includes(txt) || o.tags.some(t=>t.includes(txt)));
                    if(hit) matches.push({ card: c.name, bank: c.bank, rate: hit.rateStr, desc: hit.desc });
                });
                
                let reply = '';
                if(matches.length > 0) {
                    matches.sort((a,b) => parseFloat(b.rate) - parseFloat(a.rate));
                    const best = matches[0];
                    reply = `æ¨è–¦æ‚¨åˆ· <b>${best.bank} ${best.card}</b>ï¼Œé€™ç­†æ¶ˆè²»æœ€é«˜æœ‰ <span class="text-pink-500 font-bold">${best.rate}</span> å›é¥‹å–”ï¼(${best.desc})`;
                } else {
                    reply = `æŠ±æ­‰ï¼Œæˆ‘æ‰¾ä¸åˆ°é—œæ–¼ã€Œ${txt}ã€çš„ç‰¹å®šå„ªæƒ ã€‚å»ºè­°åˆ·ä¸€èˆ¬å›é¥‹é«˜çš„å¡ç‰‡ï¼Œä¾‹å¦‚ <b>è¯é‚¦å‰é¶´å¡</b> (2%)ã€‚`;
                }

                // Small Pay Check
                const isSmall = SMALL_PAYMENT_STORES_DB.some(s => s.name.includes(txt));
                if(isSmall) reply += `<br><br><span class="text-red-500 font-bold text-xs">âš ï¸ æ³¨æ„ï¼š${txt} å¯èƒ½æ˜¯å°é¡æ”¯ä»˜åº—å®¶ï¼Œè«‹ç•™æ„å›é¥‹æ¢æ¬¾ã€‚</span>`;

                const a = document.createElement('div'); a.className = "flex gap-3 animate-in slide-in-from-left-5";
                a.innerHTML = `<div class="w-8 h-8 rounded-full bg-gradient-to-br from-pink-400 to-rose-400 flex items-center justify-center text-white flex-shrink-0"><i data-lucide="bot" class="w-4 h-4"></i></div><div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-700 max-w-[80%]">${reply}</div>`;
                content.appendChild(a);
                content.scrollTop = content.scrollHeight;
            }, 600);
        }

        document.getElementById('bankSelect').addEventListener('change', (e) => { currentBankFilter = e.target.value; currentCardFilter = ''; const s=document.getElementById('cardSelect'); s.innerHTML='<option value="">æ‰€æœ‰å¡ç‰‡</option>'; if(currentBankFilter) { allCardsData.filter(c=>c.bank===currentBankFilter).forEach(c=>{const o=document.createElement('option');o.value=c.name;o.text=c.name;s.appendChild(o)});s.disabled=false;}else s.disabled=true; renderView(); });
        document.getElementById('cardSelect').addEventListener('change', (e) => { currentCardFilter = e.target.value; renderView(); });
        document.getElementById('manageCardFilter').addEventListener('change', (e) => { manageCardFilter = e.target.value; renderView(); });
        document.getElementById('searchInput').addEventListener('input', (e) => { document.getElementById('clearBtn').style.display = e.target.value ? 'block' : 'none'; if(currentView === 'search') renderView(); });
        document.getElementById('clearBtn').addEventListener('click', () => { document.getElementById('searchInput').value = ''; document.getElementById('clearBtn').style.display = 'none'; renderView(); });

        init();
    </script>
</body>
</html>